<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PolyClass æ•™å¸ˆç«¯åŸå‹</title>
  <style>
    :root{
      --bg:#f5f9ff; --panel:#e6f0ff; --card:#ffffff; --border:#bcd2f0; --muted:#557aa3;
      --text:#0a1f33; --primary:#3a82f6; --primary-2:#60a5fa; --accent:#22d3ee;
      --ok:#16a34a; --warn:#f59e0b; --danger:#dc2626; --sidebar-width:220px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC",sans-serif}
    a{color:inherit;text-decoration:none}
    .btn{display:inline-flex;gap:8px;align-items:center;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--panel);cursor:pointer;transition:background .2s}
    .btn.primary{background:linear-gradient(90deg,var(--primary),var(--primary-2));border:0;color:#fff;font-weight:700}
    .btn:hover{background:var(--primary-2);color:#fff}
    .input,select,textarea{padding:12px 14px;border-radius:10px;border:1px solid var(--border);background:#fff;color:var(--text);width:100%}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 2px 4px rgba(0,0,0,.05)}
    .grid{display:grid;gap:16px}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
    .status{padding:4px 8px;border-radius:999px;font-size:12px}
    .on{background:#dcfce7;color:#166534}
    .off{background:#fee2e2;color:#991b1b}
    .topbar{position:fixed;left:0;right:0;top:0;height:56px;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:20}
    .brand{display:flex;gap:10px;align-items:center;font-weight:700;font-size:18px}
    .brand .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#60a5fa,#22d3ee)}
    .top-actions{display:flex;gap:10px;align-items:center}
    .avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#3b82f6,#06b6d4);cursor:pointer;border:2px solid #fff}
    .layout{display:flex;margin-top:56px;min-height:calc(100vh - 56px)}
    .sidebar{width:var(--sidebar-width);background:var(--panel);border-right:1px solid var(--border);padding:12px;display:flex;flex-direction:column;gap:8px}
    .nav a{padding:10px 12px;border-radius:8px;display:flex;align-items:center;gap:10px;color:var(--muted);transition:background .2s;cursor:pointer}
    .nav a.active,.nav a:hover{background:var(--primary-2);color:#fff}
    .content{flex:1;padding:18px;overflow:auto}
    .center{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .login-panel{max-width:560px;width:100%}
    .role{flex:1;padding:14px;border-radius:12px;border:1px solid var(--border);background:#fff;text-align:center;cursor:pointer}
    .role.active{outline:2px solid var(--primary)}
    .classroom-grid{display:grid;grid-template-columns: 1fr 320px;gap:16px;align-items:start}
    .activity-aside{position:sticky;top:86px;display:flex;flex-direction:column;gap:10px}
    .activity-aside .mini-card{padding:12px;border-radius:14px;border:1px solid var(--border);background:var(--card);box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .mini-title{font-weight:700;margin-bottom:4px}
    .mini-actions{display:flex;gap:8px;flex-wrap:wrap}
    .bottom-dock{position:fixed;left: calc(var(--sidebar-width) + 18px);right:18px;bottom:16px;z-index:14;display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap}
    .question-chip{background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px 12px;box-shadow:0 2px 6px rgba(0,0,0,.05);display:flex;gap:8px;align-items:center;cursor:pointer}
    .deadline{font-size:12px;color:var(--muted)}
    .modal-mask{position:fixed;inset:0;background:rgba(10,31,51,.35);display:none;align-items:center;justify-content:center;z-index:30}
    .modal{width:min(680px,92vw);background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 12px 30px rgba(0,0,0,.2)}
    .modal header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .modal footer{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}

    /* æ–°å¢ï¼šè¯¾ç¨‹å­å¯¼èˆªæ ·å¼ */
    .subnav{margin:6px 0 4px 10px;display:flex;flex-direction:column;gap:4px}
    .subnav a{padding:8px 12px 8px 28px;border-radius:8px;color:var(--muted)}
    .subnav a.active,.subnav a:hover{background:var(--primary-2);color:#fff}
    .nav .parent{display:flex;align-items:center;justify-content:space-between}
    .nav .caret{font-size:12px;opacity:.8}

    @media(max-width:980px){
      .grid.cols-3{grid-template-columns:repeat(2,1fr)}
      .sidebar{width:auto;flex-direction:row;border-right:0;border-bottom:1px solid var(--border)}
      .content{padding:12px}
      .classroom-grid{grid-template-columns:1fr}
      .activity-aside{position:static}
      .bottom-dock{left:12px;right:12px}
    }
  </style>
</head>
<body>
  <main id="app"></main>

  <!-- é—®ç­”ç¼–è¾‘å¼¹çª— -->
  <div id="modal-mask" class="modal-mask" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <header>
        <h3 id="modal-title" style="margin:0">æ–°å»ºé—®ç­”</h3>
        <button class="btn" onclick="closeModal()">âœ–</button>
      </header>
      <div style="display:flex;flex-direction:column;gap:10px">
        <label><div class="muted">é—®é¢˜æ ‡é¢˜</div><input id="q-title" class="input" placeholder="è¯·è¾“å…¥é—®é¢˜æ ‡é¢˜ï¼ˆå¿…å¡«ï¼‰"/></label>
        <label><div class="muted">è¯¦ç»†è¯´æ˜</div><textarea id="q-desc" class="input" rows="4" placeholder="å¯è¡¥å……èƒŒæ™¯ã€ç­”é¢˜è¦æ±‚ç­‰"></textarea></label>
        <label><div class="muted">æˆªæ­¢æ—¶é—´</div><input id="q-deadline" class="input" type="datetime-local"/></label>
      </div>
      <footer>
        <button class="btn" onclick="closeModal()">å–æ¶ˆ</button>
        <button class="btn primary" onclick="saveQuestion()">ä¿å­˜</button>
      </footer>
    </div>
  </div>

  <script>
    const API_BASE = ''; // åŒåŸŸéƒ¨ç½²ï¼Œç•™ç©ºå³å¯ã€‚å¦‚è·¨åŸŸå¯æ”¹ä¸º 'http://localhost:3000'
    const state = {
      user: null,
      courses: [],
      students: [],
      questions: [], // å½“å‰è¯¾ç¨‹çš„é—®ç­”
      joinCode: ''
    };

    /* è·¯ç”±ï¼šæ–°å¢ä¸‰ä¸ªè¯¾ç¨‹å­é¡µ */
    const routes = {
      '#/login': renderLogin,
      '#/teacher': renderTeacherShell,
      '#/teacher/profile': renderTeacherProfile,
      '#/teacher/courses': renderCourses,
      '#/teacher/classroom': renderClassroom,              // è¿›å…¥è¯¾å ‚ï¼ˆåŸï¼‰
      '#/teacher/classroom/ai': renderClassAI,             // æ–°ï¼šAI åŠ©æ‰‹
      '#/teacher/classroom/discuss': renderClassDiscuss,   // æ–°ï¼šè®¨è®ºåŒº
      '#/teacher/classroom/timeline': renderClassTimeline, // æ–°ï¼šæ—¶é—´è¡¨
      '#/teacher/ai': renderAIStudio,                      // å…¨å±€å®éªŒå®¤ï¼ˆä¿ç•™ï¼‰
      '#/teacher/insights': renderInsights
    };

    function mount(html){ document.getElementById('app').innerHTML = html; }
    function goto(hash){ location.hash = hash; }
    function removeFloatingUI(){
      document.getElementById('bottom-dock')?.remove();
      const mask = document.getElementById('modal-mask');
      if(mask) mask.style.display = 'none';
    }

    // ---- API helpers ----
    async function api(path, options={}){
      const res = await fetch(API_BASE + path, {
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        ...options
      });
      if(!res.ok){
        const t = await res.json().catch(()=>({message: res.statusText}));
        throw new Error(t.message || `HTTP ${res.status}`);
      }
      return res.json();
    }

    // ---- ç™»å½•é¡µ ----
    function renderLogin(){
      mount(`
        <div class='center'>
          <div class='card login-panel'>
            <h2>ç™»å½• PolyClass</h2>
            <p class='muted'>è¯·é€‰æ‹©è§’è‰²ç™»å½•ï¼ˆå½“å‰ä»…å¼€æ”¾æ•™å¸ˆç«¯ï¼‰ã€‚</p>
            <div class='grid cols-3' style='margin:12px 0'>
              <div class='role' data-role='teacher'>æ•™å¸ˆ</div>
              <div class='role' data-role='student'>å­¦ç”Ÿ</div>
              <div class='role' data-role='admin'>ç®¡ç†å‘˜</div>
            </div>
            <div style='display:flex;gap:10px;'>
              <input class='input' id='email' placeholder='é‚®ç®±' value='teacher@polyclass.edu'/>
              <input class='input' id='pwd' placeholder='å¯†ç ' type='password' value='123456'/>
            </div>
            <div style='margin-top:16px;display:flex;justify-content:space-between;align-items:center'>
              <span class='muted'>è½»è“ä¸»é¢˜ Â· Teamsé£æ ¼</span>
              <button class='btn primary' id='login-btn'>ç™»å½•</button>
            </div>
          </div>
        </div>
      `);
      let selectedRole = 'teacher';
      document.querySelectorAll('.role').forEach(el=>{
        el.addEventListener('click',()=>{
          document.querySelectorAll('.role').forEach(x=>x.classList.remove('active'));
          el.classList.add('active'); selectedRole = el.dataset.role;
        });
      });
      document.querySelector(".role[data-role='teacher']").classList.add('active');

      document.getElementById('login-btn').addEventListener('click', async ()=>{
        try{
          const email = document.getElementById('email').value.trim();
          const password = document.getElementById('pwd').value;
          const data = await api('/api/login', {
            method:'POST',
            body: JSON.stringify({ email, password, role: selectedRole })
          });
          state.user = data.user;
          goto('#/teacher');
        }catch(e){
          alert('ç™»å½•å¤±è´¥ï¼š' + e.message);
        }
      });
    }

    function selectRole(r){ sessionStorage.setItem('role', r); }

    /* ä¾§è¾¹æ ï¼šè¯¾ç¨‹ä¸»æ  + å­é¡¹ï¼ˆAI/è®¨è®ºåŒº/æ—¶é—´è¡¨ï¼‰ */
    function shell(content, active){
      const hasCourse = !!sessionStorage.getItem('currCourse');
      const subActive = location.hash.startsWith('#/teacher/classroom')
        ? location.hash : null;

      const courseTitle = (() => {
        const cid = sessionStorage.getItem('currCourse');
        if(!cid) return '';
        const c = state.courses.find(x=>x.id===cid);
        return c ? `${c.title}` : `è¯¾ç¨‹ ${cid}`;
      })();

      return `
      <header class='topbar'>
        <div class='brand' onclick="goto('#/teacher/courses')" style='cursor:pointer'>
          <div class='logo'></div>
          <div>PolyClass</div>
        </div>
        <div class='top-actions'>
          <span>${state.user?.email||''}</span>
          <div class='avatar' onclick="goto('#/teacher/profile')" title='æŸ¥çœ‹ä¸ªäººä¿¡æ¯'></div>
        </div>
      </header>
      <div class='layout'>
        <aside class='sidebar'>
          <nav class='nav'>
            <a class='${active==='courses'?'active':''} parent' onclick="goto('#/teacher/courses')">
              <span>ğŸ“š è¯¾ç¨‹</span>
              <span class='caret'>${hasCourse ? 'â–¼' : ''}</span>
            </a>

            ${hasCourse ? `
              <div class="subnav">
                <a class='${subActive==='#/teacher/classroom'?'active':''}'
                   onclick="goto('#/teacher/classroom')">ğŸ« è¿›å…¥è¯¾å ‚ Â· ${courseTitle}</a>
                <a class='${subActive==='#/teacher/classroom/ai'?'active':''}'
                   onclick="goto('#/teacher/classroom/ai')">ğŸ¤– AI åŠ©æ‰‹</a>
                <a class='${subActive==='#/teacher/classroom/discuss'?'active':''}'
                   onclick="goto('#/teacher/classroom/discuss')">ğŸ’¬ è®¨è®ºåŒº</a>
                <a class='${subActive==='#/teacher/classroom/timeline'?'active':''}'
                   onclick="goto('#/teacher/classroom/timeline')">ğŸ—“ï¸ æ—¶é—´è¡¨</a>
              </div>
            `:''}

            <a class='${active==='ai'?'active':''}' onclick="goto('#/teacher/ai')">ğŸ§ª å®éªŒå®¤ï¼ˆå…¨å±€ï¼‰</a>
            <a class='${active==='insights'?'active':''}' onclick="goto('#/teacher/insights')">ğŸ“ˆ ä¿¡æ¯å±•ç¤º</a>
          </nav>
        </aside>
        <section class='content'>${content}</section>
      </div>`;
    }

    function renderTeacherShell(){ goto('#/teacher/courses'); }

    function renderTeacherProfile(){
      const html = `<div class='card'><h3>ä¸ªäººä¿¡æ¯</h3><p>å§“åï¼š${state.user?.name||'â€”'}</p><p>é‚®ç®±ï¼š${state.user?.email||'â€”'}</p><p>è§’è‰²ï¼š${state.user?.role||'â€”'}</p><button class='btn primary' onclick="goto('#/login')">é€€å‡ºç™»å½•</button></div>`;
      mount(shell(html,'profile'));
    }

    // ---- è¯¾ç¨‹é¡µ ----
    async function renderCourses(){
      try{
        const { data } = await api('/api/courses');
        state.courses = data;
      }catch(e){
        alert('è·å–è¯¾ç¨‹å¤±è´¥ï¼š' + e.message);
      }

      const cards = state.courses.map(c=>`
        <div class='card'>
          <b>${c.title}</b>
          <div class='muted'>ç¼–å·ï¼š${c.id} Â· å­¦ç”Ÿ ${c.students} Â· æ›´æ–° ${c.updated}</div>
          <div style='margin-top:8px'>
            <button class='btn primary' onclick="openClassroom('${c.id}')">è¿›å…¥è¯¾å ‚</button>
          </div>
        </div>`).join('');

      const html = `<h2>è¯¾ç¨‹</h2>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
        <div class="muted">ç®¡ç†/æµè§ˆä½ çš„è¯¾ç¨‹</div>
        <div style="display:flex; gap:8px">
          <button class="btn">â• åŠ å…¥è¯¾ç¨‹</button>
          <button class="btn primary">â• æ–°å»ºè¯¾ç¨‹</button>
        </div>
      </div>
      <div class='grid cols-2'>${cards}</div>`;
      mount(shell(html,'courses'));
    }

    function openClassroom(cid){
      sessionStorage.setItem('currCourse', cid);
      goto('#/teacher/classroom');
    }

    // ---- è¯¾å ‚é¡µï¼ˆåŸï¼‰ ----
    async function renderClassroom(){
      const cid = sessionStorage.getItem('currCourse');
      if(!cid && state.courses.length) sessionStorage.setItem('currCourse', state.courses[0].id);
      const courseId = sessionStorage.getItem('currCourse') || '';

      // å¹¶å‘è·å–å­¦ç”Ÿ/é—®é¢˜/åŠ å…¥ç 
      try{
        const [stuRes, qRes, joinRes] = await Promise.all([
          api(`/api/courses/${courseId}/students`),
          api(`/api/courses/${courseId}/questions`),
          api(`/api/courses/${courseId}/join-code`)
        ]);
        state.students = stuRes.data;
        state.questions = qRes.data;
        state.joinCode = joinRes.code;
      }catch(e){
        alert('åŠ è½½è¯¾å ‚æ•°æ®å¤±è´¥ï¼š' + e.message);
      }

      const c = (state.courses.find(x=>x.id===courseId) || { id: courseId, title: courseId });

      const studentRows = state.students.map(s=>`
        <tr>
          <td>${s.id}</td>
          <td>${s.name}</td>
          <td><span class='status ${s.status==='online'?'on':'off'}'>${s.status==='online'?'åœ¨çº¿':'ç¦»çº¿'}</span></td>
          <td>${s.score}</td>
          <td>${s.submissions}</td>
          <td><button class='btn'>è¯¦æƒ…</button></td>
        </tr>
      `).join('');

      const html = `
        <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:12px'>
          <div>
            <small class='muted'>è¯¾å ‚ / ${c.id}</small>
            <h2 style='margin:4px 0 0 0'>${c.title}</h2>
          </div>
          <div style='display:flex;gap:8px'>
            <button class='btn' onclick="goto('#/teacher/courses')">è¿”å›è¯¾ç¨‹åˆ—è¡¨</button>
            <button class='btn' onclick="copyJoinCode()">å¤åˆ¶åŠ å…¥ç </button>
          </div>
        </div>

        <div class="classroom-grid">
          <div class='card'>
            <h3 style='margin-top:0'>å­¦ç”Ÿæ¦‚è§ˆ</h3>
            <table>
              <thead><tr><th>å­¦å·</th><th>å§“å</th><th>çŠ¶æ€</th><th>å¹³å‡åˆ†</th><th>æäº¤æ¬¡æ•°</th><th>æ“ä½œ</th></tr></thead>
              <tbody>${studentRows}</tbody>
            </table>
          </div>

          <aside class="activity-aside">
            <div class="mini-card">
              <div class="mini-title">ğŸ—³ï¸ æŠ•ç¥¨</div>
              <div class="muted" style="margin-bottom:8px">å•é€‰ / å¤šé€‰</div>
              <div class="mini-actions">
                <button class="btn primary" onclick="alert('æŠ•ç¥¨åˆ›å»ºæš‚æœªå®ç°')">æ–°å»ºæŠ•ç¥¨</button>
                <button class="btn" onclick="alert('æŠ•ç¥¨å†å²æš‚æœªå®ç°')">å†å²è®°å½•</button>
              </div>
            </div>
            <div class="mini-card">
              <div class="mini-title">ğŸ“ é—®ç­”</div>
              <div class="muted" style="margin-bottom:8px">ç®€ç­” / è¯äº‘</div>
              <div class="mini-actions">
                <button class="btn primary" onclick="openQuestionModal()">æ–°å»ºé—®ç­”</button>
                <button class="btn" onclick="alert('é—®ç­”å†å²æš‚æœªå®ç°')">å†å²è®°å½•</button>
              </div>
            </div>
            <div class="mini-card">
              <div class="mini-title">ğŸ® å°æ¸¸æˆ</div>
              <div class="muted" style="margin-bottom:8px">æŠ¢ç­” / æ’è¡Œæ¦œ</div>
              <div class="mini-actions">
                <button class="btn primary" onclick="alert('å°æ¸¸æˆåˆ›å»ºæš‚æœªå®ç°')">åˆ›å»ºæ¸¸æˆ</button>
                <button class="btn" onclick="alert('å°æ¸¸æˆå†å²æš‚æœªå®ç°')">å†å²è®°å½•</button>
              </div>
            </div>
          </aside>
        </div>
      `;
      mount(shell(html,'courses'));

      // æ¸²æŸ“åº•éƒ¨é—®é¢˜æ 
      renderBottomDock(courseId);
    }

    function renderBottomDock(courseId){
      const prev = document.getElementById('bottom-dock');
      if(prev) prev.remove();
      const list = state.questions || [];
      if(list.length === 0){ return; }
      const dock = document.createElement('div');
      dock.id = 'bottom-dock';
      dock.className = 'bottom-dock';
      dock.innerHTML = list.map(q => `
        <div class="question-chip" onclick="openQuestionModal('${q.id}')">
          <strong>Q:</strong> <span>${escapeHTML(q.title)}</span>
          ${q.deadlineISO ? `<span class="deadline">Â· æˆªæ­¢ ${fmtDeadline(q.deadlineISO)}</span>` : ''}
        </div>
      `).join('');
      document.body.appendChild(dock);
    }

    async function copyJoinCode(){
      const cid = sessionStorage.getItem('currCourse');
      try{
        const { code } = await api(`/api/courses/${cid}/join-code`);
        await navigator.clipboard?.writeText(code);
        alert('åŠ å…¥ç å·²å¤åˆ¶ï¼š' + code);
      }catch(e){
        alert('å¤åˆ¶å¤±è´¥ï¼š' + e.message);
      }
    }

    // ---- å¼¹çª—ï¼šæ–°å»º/ç¼–è¾‘é—®ç­” ----
    let editingQuestionId = null;

    function openQuestionModal(id=null){
      editingQuestionId = id;
      const titleEl = document.getElementById('q-title');
      const descEl  = document.getElementById('q-desc');
      const ddlEl   = document.getElementById('q-deadline');
      const header  = document.getElementById('modal-title');

      if(id){
        const q = (state.questions || []).find(x=>x.id===id);
        header.textContent = 'ç¼–è¾‘é—®ç­”';
        titleEl.value = q?.title || '';
        descEl.value  = q?.desc  || '';
        ddlEl.value   = q?.deadlineISO || '';
      }else{
        header.textContent = 'æ–°å»ºé—®ç­”';
        titleEl.value = '';
        descEl.value  = '';
        const d = new Date(Date.now() + 60*60*1000);
        ddlEl.value = toLocalDatetimeValue(d);
      }

      document.getElementById('modal-mask').style.display = 'flex';
    }

    function closeModal(ev){
      if(ev && ev.target && ev.target.id && ev.target.id !== 'modal-mask'){ return; }
      document.getElementById('modal-mask').style.display = 'none';
      editingQuestionId = null;
    }

    async function saveQuestion(){
      const cid = sessionStorage.getItem('currCourse');
      const title = document.getElementById('q-title').value.trim();
      const desc  = document.getElementById('q-desc').value.trim();
      const ddl   = document.getElementById('q-deadline').value;

      if(!title){ alert('è¯·å¡«å†™é—®é¢˜æ ‡é¢˜'); return; }

      try{
        if(editingQuestionId){
          const data = await api(`/api/courses/${cid}/questions/${editingQuestionId}`, {
            method:'PUT',
            body: JSON.stringify({ title, desc, deadlineISO: ddl || '' })
          });
          const idx = state.questions.findIndex(q=>q.id===editingQuestionId);
          if(idx>=0) state.questions[idx] = data.data;
        }else{
          const data = await api(`/api/courses/${cid}/questions`, {
            method:'POST',
            body: JSON.stringify({ title, desc, deadlineISO: ddl || '' })
          });
          state.questions.push(data.data);
        }
        closeModal();
        renderBottomDock(cid);
      }catch(e){
        alert('ä¿å­˜å¤±è´¥ï¼š' + e.message);
      }
    }

    /* â€”â€” æ–°å¢é¡µé¢ï¼šAI åŠ©æ‰‹ â€”â€” */
    function renderClassAI(){
      const cid = sessionStorage.getItem('currCourse') || '';
      const c = state.courses.find(x=>x.id===cid) || { title: cid, id: cid };

      const html = `
        <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:12px'>
          <div>
            <small class='muted'>è¯¾å ‚ / ${c.id}</small>
            <h2 style='margin:4px 0 0 0'>AI åŠ©æ‰‹ Â· ${c.title}</h2>
          </div>
          <div style='display:flex;gap:8px'>
            <button class='btn' onclick="goto('#/teacher/classroom')">è¿”å›è¯¾å ‚</button>
          </div>
        </div>

        <div class='grid cols-2'>
          <div class='card'>
            <h3 style='margin-top:0'>ğŸ§­ è‡ªåŠ¨å¤‡è¯¾</h3>
            <div class='muted'>æ ¹æ®æ•™å­¦ç›®æ ‡ä¸ææ–™å¿«é€Ÿç”Ÿæˆæ•™å­¦å¤§çº²ã€çŸ¥è¯†ç‚¹ä¸æ´»åŠ¨å»ºè®®ã€‚</div>
            <div style='display:flex;gap:8px;margin-top:12px'>
              <input class='input' id='plan-topic' placeholder='è¾“å…¥æœ¬èŠ‚è¯¾ä¸»é¢˜/ææ–™é“¾æ¥'/>
              <button class='btn primary' onclick="alert('ç¤ºä¾‹ï¼šå·²ç”Ÿæˆæ•™æ¡ˆè‰ç¨¿ï¼ˆæ¥å£ç•™ç©ºï¼Œå¯æ¥åç«¯ï¼‰')">ç”Ÿæˆæ•™æ¡ˆ</button>
            </div>
          </div>

          <div class='card'>
            <h3 style='margin-top:0'>âœï¸ è‡ªåŠ¨äº§ç”Ÿé¢˜ç›®</h3>
            <div class='muted'>ä»æ•™æ/è¯¾ä»¶æŠ½å–é€‰æ‹©é¢˜ã€ç®€ç­”é¢˜ï¼Œæ”¯æŒéš¾åº¦ä¸é¢˜é‡è®¾ç½®ã€‚</div>
            <div style='display:flex;gap:8px;margin-top:12px;flex-wrap:wrap'>
              <input class='input' style='max-width:220px' id='q-count' placeholder='é¢˜é‡ï¼ˆå¦‚ 10ï¼‰'/>
              <select class='input' style='max-width:220px' id='q-level'>
                <option value='easy'>å®¹æ˜“</option><option value='mid'>ä¸­ç­‰</option><option value='hard'>å›°éš¾</option>
              </select>
              <button class='btn primary' onclick="alert('ç¤ºä¾‹ï¼šå·²ç”Ÿæˆé¢˜ç›®ï¼ˆæ¥å£ç•™ç©ºï¼Œå¯æ¥åç«¯ï¼‰')">ç”Ÿæˆé¢˜ç›®</button>
            </div>
          </div>

          <div class='card'>
            <h3 style='margin-top:0'>ğŸ§¾ æ€»ç»“è¯¾ç¨‹ä¿¡æ¯</h3>
            <div class='muted'>è‡ªåŠ¨æ±‡æ€»æœ¬èŠ‚é‡ç‚¹ã€å¸¸è§é”™è¯¯ä¸æ”¹è¿›å»ºè®®ï¼Œå¯ä¸€é”®æ¨é€ç»™å­¦ç”Ÿã€‚</div>
            <button class='btn primary' style='margin-top:8px' onclick="alert('ç¤ºä¾‹ï¼šå·²ç”Ÿæˆè¯¾ç¨‹æ€»ç»“ï¼ˆæ¥å£ç•™ç©ºï¼Œå¯æ¥åç«¯ï¼‰')">ç”Ÿæˆæ€»ç»“</button>
          </div>

          <div class='card'>
            <h3 style='margin-top:0'>ğŸ” ä¸€é”®å‘å¸ƒ</h3>
            <div class='muted'>å°†æ•™æ¡ˆ/é¢˜ç›®/æ€»ç»“æ¨é€åˆ°æœ¬è¯¾ç¨‹çš„è®¨è®ºåŒºæˆ–é—®ç­”æ¨¡å—ã€‚</div>
            <button class='btn' style='margin-top:8px' onclick="alert('ç¤ºä¾‹ï¼šå·²æ¨é€åˆ°è®¨è®ºåŒºï¼ˆæ¥å£ç•™ç©ºï¼‰')">æ¨é€åˆ°è®¨è®ºåŒº</button>
          </div>
        </div>
      `;
      mount(shell(html,'courses'));
    }

    /* â€”â€” æ–°å¢é¡µé¢ï¼šè®¨è®ºåŒº â€”â€” */
    function renderClassDiscuss(){
      const cid = sessionStorage.getItem('currCourse') || '';
      const c = state.courses.find(x=>x.id===cid) || { title: cid, id: cid };

      // ç¤ºä¾‹æ•°æ®ï¼ˆå¯æ›¿æ¢ä¸º /api/courses/:cid/discussionsï¼‰
      const discussions = [
        { id:'t1', title:'é¢„ä¹ ï¼šé˜…è¯»ç¬¬2ç« å¹¶æ¦‚æ‹¬è¦ç‚¹', replies:6, author:'åŠ©æ•™A', updated:'ä»Šå¤© 14:32' },
        { id:'t2', title:'è¯¾å ‚é—®é¢˜æ”¶é›†ï¼šå¤šä¹‰è¯è¯­å¢ƒ', replies:12, author:'Teacher', updated:'æ˜¨å¤© 20:11' },
        { id:'t3', title:'ä½œä¸š1äº¤æµä¸ç­”ç–‘', replies:3, author:'åŠ©æ•™B', updated:'10-08 09:10' }
      ];

      const cards = discussions.map(d=>`
        <div class='card' onclick="alert('è¿›å…¥è¯é¢˜ ${d.title}ï¼ˆå¯æ¥è¯¦æƒ…é¡µè·¯ç”±ï¼‰')" style='cursor:pointer'>
          <b>${d.title}</b>
          <div class='muted'>å›å¤ ${d.replies} Â· å‘èµ· ${d.author} Â· æ›´æ–° ${d.updated}</div>
        </div>
      `).join('');

      const html = `
        <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:12px'>
          <div>
            <small class='muted'>è¯¾å ‚ / ${c.id}</small>
            <h2 style='margin:4px 0 0 0'>è®¨è®ºåŒº Â· ${c.title}</h2>
          </div>
          <div style='display:flex;gap:8px'>
            <button class='btn' onclick="goto('#/teacher/classroom')">è¿”å›è¯¾å ‚</button>
            <button class='btn primary' onclick="alert('æ–°å»ºè¯é¢˜ï¼ˆå¯æ¥åç«¯ï¼‰')">æ–°å»ºè¯é¢˜</button>
          </div>
        </div>
        <div class='grid cols-2'>${cards}</div>
      `;
      mount(shell(html,'courses'));
    }

    /* â€”â€” æ–°å¢é¡µé¢ï¼šæ—¶é—´è¡¨ â€”â€” */
    function renderClassTimeline(){
      const cid = sessionStorage.getItem('currCourse') || '';
      const c = state.courses.find(x=>x.id===cid) || { title: cid, id: cid };

      // ç¤ºä¾‹ï¼šä¸Šè¯¾å®‰æ’ + é—®ç­”/ä½œä¸šæˆªæ­¢
      const sessions = [
        { time:'2025-10-12 10:00', tag:'ä¸Šè¯¾', text:'ç¬¬4è®²ï¼šè¯­ä¹‰ä¸è¯­ç”¨' },
        { time:'2025-10-12 22:00', tag:'æˆªæ­¢', text:'é—®ç­”ï¼šè¯¾å ‚è¦ç‚¹å°ç»“' },
      ];
      const qDeadlines = (state.questions||[])
        .filter(q=>q.deadlineISO).map(q=>({
          time: fmtDeadline(q.deadlineISO).replace(/(\d{2})-(\d{2})/,'$1æœˆ$2æ—¥'),
          tag:'æˆªæ­¢', text:`é—®ç­”ï¼š${q.title}`
        }));

      const items = [...sessions, ...qDeadlines]
         .sort((a,b)=>a.time.localeCompare(b.time))
         .map(i=>`
          <div class='card'>
            <div style='display:flex;justify-content:space-between;align-items:center'>
              <b>${i.text}</b>
              <span class='status ${i.tag==='æˆªæ­¢'?'off':'on'}'>${i.tag}</span>
            </div>
            <div class='muted' style='margin-top:6px'>${i.time}</div>
          </div>
         `).join('');

      const html = `
        <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:12px'>
          <div>
            <small class='muted'>è¯¾å ‚ / ${c.id}</small>
            <h2 style='margin:4px 0 0 0'>æ—¶é—´è¡¨ Â· ${c.title}</h2>
          </div>
          <div style='display:flex;gap:8px'>
            <button class='btn' onclick="goto('#/teacher/classroom')">è¿”å›è¯¾å ‚</button>
            <button class='btn' onclick="alert('å¯¼å‡ºæ—¥ç¨‹ï¼ˆå¯æ¥ iCal/ICSï¼‰')">å¯¼å‡º</button>
          </div>
        </div>
        <div class='grid cols-2'>${items || '<div class="card">æš‚æ— å®‰æ’</div>'}</div>
      `;
      mount(shell(html,'courses'));
    }

    // å…¶ä»–é¡µé¢ï¼ˆä¿ç•™ï¼‰
    function renderAIStudio(){
      const html = `<h2>AI è¾…åŠ©åŠŸèƒ½</h2><div class='grid cols-2'><div class='card'><b>ä»ææ–™ç”Ÿæˆé¢˜ç›®</b></div><div class='card'><b>ç›¸ä¼¼ç­”æ¡ˆèšç±»</b></div></div>`;
      mount(shell(html,'ai'));
    }
    function renderInsights(){
      const html = `<h2>ä¿¡æ¯å±•ç¤º</h2><div class='grid cols-3'><div class='card'><b>å­¦ç”Ÿå‚ä¸åº¦</b></div><div class='card'><b>å¹³å‡æ­£ç¡®ç‡</b></div><div class='card'><b>æäº¤æ—¶é•¿</b></div></div>`;
      mount(shell(html,'insights'));
    }

    // è·¯ç”±
    function route(){
      removeFloatingUI();
      const h = location.hash || '#/login';
      (routes[h]||renderLogin)();
    }
    window.addEventListener('hashchange', route);
    route();

    // å°å·¥å…·å‡½æ•°
    function toLocalDatetimeValue(date){
      const pad = n => String(n).padStart(2,'0');
      const y = date.getFullYear(), m = pad(date.getMonth()+1), d = pad(date.getDate());
      const hh = pad(date.getHours()), mm = pad(date.getMinutes());
      return `${y}-${m}-${d}T${hh}:${mm}`;
    }
    function fmtDeadline(iso){
      if(!iso) return '';
      const d = new Date(iso);
      if(isNaN(d)) return iso;
      const pad = n => String(n).padStart(2,'0');
      return `${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    function escapeHTML(str=''){
      return str.replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s]));
    }
  </script>
</body>
</html>
