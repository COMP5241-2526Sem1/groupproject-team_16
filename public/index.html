<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PolyClass Teacher Prototype</title>
  <style>
    :root{
      --bg:#f5f9ff; --panel:#e6f0ff; --card:#ffffff; --border:#bcd2f0; --muted:#557aa3;
      --text:#0a1f33; --primary:#3a82f6; --primary-2:#60a5fa; --accent:#22d3ee;
      --ok:#16a34a; --warn:#f59e0b; --danger:#dc2626; --sidebar-width:260px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC",sans-serif}
    a{color:inherit;text-decoration:none}
    .btn{display:inline-flex;gap:8px;align-items:center;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--panel);cursor:pointer;transition:background .2s}
    .btn.primary{background:linear-gradient(90deg,var(--primary),var(--primary-2));border:0;color:#fff;font-weight:700}
    .btn:hover{background:var(--primary-2);color:#fff}
    .btn.ghost{background:transparent}
    .input,select,textarea{padding:12px 14px;border-radius:10px;border:1px solid var(--border);background:#fff;color:var(--text);width:100%}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 2px 4px rgba(0,0,0,.05)}
    .grid{display:grid;gap:16px}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
    .status{padding:4px 8px;border-radius:999px;font-size:12px}
    .on{background:#dcfce7;color:#166534}
    .off{background:#fee2e2;color:#991b1b}
    .topbar{position:fixed;left:0;right:0;top:0;height:56px;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:20}
    .brand{display:flex;gap:10px;align-items:center;font-weight:700;font-size:18px}
    .brand .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#60a5fa,#22d3ee)}
    .top-actions{display:flex;gap:10px;align-items:center}
    .avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#3b82f6,#06b6d4);cursor:pointer;border:2px solid #fff}
    .layout{display:flex;margin-top:56px;min-height:calc(100vh - 56px)}
    .sidebar{width:var(--sidebar-width);background:var(--panel);border-right:1px solid var(--border);padding:12px;display:flex;flex-direction:column;gap:8px}
    .nav a, .nav .nav-item{padding:10px 12px;border-radius:8px;display:flex;align-items:center;gap:10px;color:var(--muted);transition:background .2s;cursor:pointer}
    .nav a.active,.nav .nav-item.active,.nav a:hover,.nav .nav-item:hover{background:var(--primary-2);color:#fff}
    .content{flex:1;padding:18px;overflow:auto}
    .center{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .login-panel{max-width:560px;width:100%}
    .role{flex:1;padding:14px;border-radius:12px;border:1px solid var(--border);background:#fff;text-align:center;cursor:pointer}
    .role.active{outline:2px solid var(--primary)}
    .classroom-grid{display:grid;grid-template-columns: 1fr 320px;gap:16px;align-items:start}
    .activity-aside{position:sticky;top:86px;display:flex;flex-direction:column;gap:10px}
    .activity-aside .mini-card{padding:12px;border-radius:14px;border:1px solid var(--border);background:var(--card);box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .mini-title{font-weight:700;margin-bottom:4px}
    .mini-actions{display:flex;gap:8px;flex-wrap:wrap}
    .bottom-dock{position:fixed;left: calc(var(--sidebar-width) + 18px);right:18px;bottom:16px;z-index:14;display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap}
    .question-chip{background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px 12px;box-shadow:0 2px 6px rgba(0,0,0,.05);display:flex;gap:8px;align-items:center;cursor:pointer}
    .deadline{font-size:12px;color:var(--muted)}
    .modal-mask{position:fixed;inset:0;background:rgba(10,31,51,.35);display:none;align-items:center;justify-content:center;z-index:30}
    .modal{width:min(760px,92vw);background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 12px 30px rgba(0,0,0,.2)}
    .modal header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .modal footer{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}

  /* Navigation styles */
    .nav-title{padding:12px 16px;font-weight:800;color:var(--text);cursor:pointer;display:flex;justify-content:space-between;align-items:center;border-radius:10px}
    .nav-title:hover{background:var(--panel)}
    .nav-group{margin-left:8px}
    .subnav{margin:6px 0 6px 16px;display:flex;flex-direction:column;gap:4px}
    .caret{font-size:12px;opacity:.8;transition:transform .18s ease}
    .caret.expanded{transform:rotate(90deg)}
    .course-parent{display:flex;justify-content:space-between;align-items:center}
    .course-name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

  /* Discussion page styles */
    .segmented{display:inline-flex;border:1px solid var(--border);border-radius:10px;overflow:hidden}
    .segmented button{border:0;background:#fff;padding:8px 12px}
    .segmented button.active{background:var(--primary-2);color:#fff}
    .chat-box{display:flex;flex-direction:column;height:420px;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .chat-scroll{flex:1;overflow:auto;padding:12px;background:#f8fbff}
    .msg{margin:8px 0;display:flex;gap:8px}
    .msg.me{justify-content:flex-end}
    .msg .bubble{max-width:70%;padding:8px 10px;border-radius:12px;border:1px solid var(--border);background:#fff}
    .msg.me .bubble{background:#e8f0ff}
    .chat-input{display:flex;gap:8px;padding:8px;border-top:1px solid var(--border);background:#fff}

  /* Timetable */
    .filter-row{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    .calendar-day{font-weight:700;margin:8px 0 4px}
    .calendar-item{padding:10px;border:1px solid var(--border);border-radius:10px;margin:6px 0;background:#fff}

  /* Hall management table + error bar */
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px;border-bottom:1px solid var(--border);text-align:left}
    #error-bar{position:fixed;left:0;right:0;bottom:0;background:#dc2626;color:#fff;padding:8px 12px;display:none;z-index:9999}
    #error-bar .close{float:right;cursor:pointer;padding:0 6px}
    @media(max-width:980px){
      .grid.cols-3{grid-template-columns:repeat(2,1fr)}
      .sidebar{width:auto;flex-direction:row;border-right:0;border-bottom:1px solid var(--border)}
      .content{padding:12px}
      .classroom-grid{grid-template-columns:1fr}
      .activity-aside{position:static}
      .bottom-dock{left:12px;right:12px}
    }
  </style>
</head>
<body>
  <main id="app"></main>

  <!-- Common Modal -->
  <div id="modal-mask" class="modal-mask" onclick="closeModal(event)">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title" onclick="event.stopPropagation()">
      <header>
  <h3 id="modal-title" style="margin:0">New</h3>
  <button class="btn" aria-label="Close modal" onclick="closeModal()">✖</button>
      </header>
      <div id="modal-body" style="display:flex;flex-direction:column;gap:10px"></div>
      <footer id="modal-footer">
  <button class="btn" onclick="closeModal()">Cancel</button>
  <button class="btn primary" id="modal-save">Save</button>
      </footer>
    </div>
  </div>

  <!-- Error Bar -->
  <div id="error-bar"><span id="error-text"></span><span class="close" onclick="this.parentNode.style.display='none'">×</span></div>

  <script>
  /************** Error Overlay **************/
  (function setupErrorOverlay(){
    const show = (msg)=>{
      const bar = document.getElementById('error-bar');
      const txt = document.getElementById('error-text');
  if(bar && txt){ txt.textContent = String(msg || 'Unknown error occurred'); bar.style.display = 'block'; }
      console.error('[PolyClass Error]', msg);
    };
    window.addEventListener('error', (e)=> show(e?.error?.message || e?.message || e));
    window.addEventListener('unhandledrejection', (e)=> show(e?.reason?.message || e?.reason || e));
  })();

  /************** Basic Utilities/State **************/
  const API_BASE = '';
  const TABS = [
    { key:'classroom', label:'Enter Classroom', hash:'#/teacher/classroom' },
    { key:'ai',        label:'AI Assistant',  hash:'#/teacher/classroom/ai' },
    { key:'tools',     label:'Widgets',    hash:'#/teacher/classroom/tools' },
    { key:'discuss',   label:'Discussion',    hash:'#/teacher/classroom/discuss' },
    { key:'timeline',  label:'Timetable',    hash:'#/teacher/classroom/timeline' },
    { key:'insights',  label:'Insights',  hash:'#/teacher/classroom/insights' },
  ];
  const state = {
    user: null,
    courses: [],
    students: [],
    questions: [],
    joinCode: '',
    showcase: [
      { id:'show-001', title:'Modern Poetry Appreciation', teacher:'Mr. Wang', students:120, public:true, desc:'Aesthetics class open to everyone' },
      { id:'show-002', title:'Python Introduction', teacher:'Ms. Li', students:230, public:true, desc:'Basic syntax and project practice' }
    ],
    sessions: {},
    discussions: {},
    ui: {
      myCoursesExpanded: true,
      groupExpanded: {},
      courseExpanded: {},
      timelineFilter: 'all', // all | class | assignment
    }
  };
  const routes = {
    '#/login': renderLogin,
    '#/teacher': renderTeacherShell,
    '#/teacher/profile': renderTeacherProfile,
    '#/teacher/courses': renderCourses,
    '#/teacher/classroom': renderClassroom,
    '#/teacher/classroom/ai': renderClassAI,
    '#/teacher/classroom/tools': renderCourseTools,
    '#/teacher/classroom/insights': renderCourseInsights,
    '#/teacher/classroom/discuss': renderClassDiscuss,
    '#/teacher/classroom/timeline': renderClassTimeline,
    '#/teacher/hall': renderHall,
    '#/teacher/meeting': renderMeeting,
    '#/teacher/ai': renderAIStudio,
    '#/teacher/insights': renderInsights
  };

  function mount(html){ const el = document.getElementById('app'); if(el) el.innerHTML = html; }
  function goto(hash){ location.hash = hash; }
  function qs(sel, root=document){ return root.querySelector(sel); }
  function qsa(sel, root=document){ return [...root.querySelectorAll(sel)]; }
  function safeJSON(res){ return res.json().catch(()=>({ message: res.statusText })); }
  async function api(path, options={}){
    const res = await fetch(API_BASE + path, {
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      ...options
    });
    if(!res.ok){
      const t = await safeJSON(res);
      throw new Error(t.message || `HTTP ${res.status}`);
    }
    return res.json();
  }
  function toLocalDatetimeValue(date){
    const pad = n => String(n).padStart(2,'0');
    const y = date.getFullYear(), m = pad(date.getMonth()+1), d = pad(date.getDate());
    const hh = pad(date.getHours()), mm = pad(date.getMinutes());
    return `${y}-${m}-${d}T${hh}:${mm}`;
  }
  function fmtDeadline(iso){
    try{
      if(!iso) return '';
      const d = new Date(iso);
      if(isNaN(d)) return iso;
      const pad = n => String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }catch{ return String(iso||''); }
  }
  function escapeHTML(str=''){
    return str.replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s]));
  }
  function formatCourseTitle(title){
    if(!title) return '';
    let t = title.replace(/课程/g,'').trim();
    const m = t.match(/[A-Za-z0-9]+/g);
    if(m && m.length>0){ const w = m[0]; return w.length>14 ? w.slice(0,14) : w; }
    const first = t.split(/\s+/)[0] || t;
    return first.length>14 ? first.slice(0,14) : first;
  }
  function removeFloatingUI(){
    qs('#bottom-dock')?.remove();
    const mask = qs('#modal-mask');
    if(mask) mask.style.display = 'none';
  }

  /************** Sidebar **************/
  function groupCourses(courses){
    const map = {};
    (courses||[]).forEach(c=>{
  const g = (c.group || c.category || 'Other').toString();
      if(!map[g]) map[g] = [];
      map[g].push(c);
    });
    return map;
  }
  function courseSubnavHTML(cid){
    return `
      <div class="subnav" data-course-sub="${cid}" style="display:${state.ui.courseExpanded[cid] ? 'flex' : 'none'}">
        ${TABS.map(t=>`
          <a class="nav-item course-sub-link" data-course-id="${cid}" data-href="${t.hash}" href="${t.hash}">• ${t.label}</a>
        `).join('')}
      </div>
    `;
  }
  function buildMyCourses(groups){
    const expanded = state.ui.myCoursesExpanded;
    const groupKeys = Object.keys(groups || {}).sort();
  // If there are no courses, show placeholder
    if(groupKeys.length === 0){
      return `
      <div class="nav-title" id="my-courses-title" role="button" tabindex="0" aria-expanded="${expanded}">
  <span>My Courses</span><span class="caret ${expanded?'expanded':''}">${expanded?'▼':'▶'}</span>
      </div>
      <div id="my-courses-box" style="display:${expanded?'block':'none'}">
  <div class="muted" style="padding:8px 12px">No courses</div>
      </div>`;
    }
  // Build each group (e.g., Computer Science, Linguistics) as subgroups of My Courses
    const groupsHTML = groupKeys.map(k=>{
      const gid = `group-${k}`;
      if(typeof state.ui.groupExpanded[gid] === 'undefined') state.ui.groupExpanded[gid] = true;
      const gExpanded = state.ui.groupExpanded[gid];
      const list = groups[k] || [];
      const coursesHTML = list.length ? list.map(c=>{
        if(state.ui.courseExpanded[c.id] === undefined) state.ui.courseExpanded[c.id] = false;
        const cExp = state.ui.courseExpanded[c.id];
        return `
          <div class="nav-item course-parent" data-course-toggle="${c.id}" role="button" tabindex="0" aria-expanded="${cExp}">
            <span class="course-name">📚 ${escapeHTML(formatCourseTitle(c.title||c.id))}</span>
            <span class="caret ${cExp?'expanded':''}">${cExp?'▼':'▶'}</span>
          </div>
          ${courseSubnavHTML(c.id)}
        `;
  }).join('') : `<div class="muted" style="padding:8px 12px">No courses</div>`;

      return `
        <div class="nav-group">
          <div class="nav-item" data-group="${gid}" role="button" tabindex="0" aria-expanded="${gExpanded}">
            <span>📁 ${escapeHTML(k)}</span>
            <span class="caret ${gExpanded ? 'expanded' : ''}">${gExpanded ? '▼' : '▶'}</span>
          </div>
          <div class="subnav" data-sub="${gid}" style="display:${gExpanded ? 'flex' : 'none'}">
            ${coursesHTML}
          </div>
        </div>
      `;
    }).join('');

    return `
      <div class="nav-title" id="my-courses-title" role="button" tabindex="0" aria-expanded="${expanded}">
  <span>My Courses</span><span class="caret ${expanded?'expanded':''}">${expanded?'▼':'▶'}</span>
      </div>
      <div id="my-courses-box" style="display:${expanded?'block':'none'}">
        ${groupsHTML}
      </div>
    `;
  }
  function buildOtherGroups(groups){
    let html = '';
    Object.keys(groups).sort().forEach(k=>{
  if(k === 'Other') return;
      const gid = `group-${k}`;
      if(typeof state.ui.groupExpanded[gid] === 'undefined') state.ui.groupExpanded[gid] = true;
      const expanded = state.ui.groupExpanded[gid];
      html += `
        <div class="nav-group">
          <div class="nav-item" data-group="${gid}" role="button" tabindex="0" aria-expanded="${expanded}">
            <span>📁 ${escapeHTML(k)}</span>
            <span class="caret ${expanded ? 'expanded' : ''}">${expanded ? '▼' : '▶'}</span>
          </div>
          <div class="subnav" data-sub="${gid}" style="display:${expanded ? 'flex' : 'none'}">
            ${groups[k].map(c=>{
              if(state.ui.courseExpanded[c.id] === undefined) state.ui.courseExpanded[c.id] = false;
              const cExp = state.ui.courseExpanded[c.id];
              return `
                <div class="nav-item course-parent" data-course-toggle="${c.id}" role="button" tabindex="0" aria-expanded="${cExp}">
                  <span class="course-name">📚 ${escapeHTML(formatCourseTitle(c.title||c.id))}</span>
                  <span class="caret ${cExp?'expanded':''}">${cExp?'▼':'▶'}</span>
                </div>
                ${courseSubnavHTML(c.id)}
              `;
            }).join('')}
          </div>
        </div>
      `;
    });
    return html;
  }
  function buildPrefixLinks(){
    return `
  <a class="nav-item" href="#/teacher/hall">🏛️ Course Hall</a>
  <a class="nav-item" href="#/teacher/meeting">🎥 Video Meeting</a>
    `;
  }
  function renderSidebar(){
    const nav = qs('.sidebar .nav');
    if(!nav) return;
    const groups = groupCourses(state.courses || []);
    nav.innerHTML = `
      ${buildMyCourses(groups)}
      <div style="height:8px"></div>
      ${buildPrefixLinks()}
    `;
    const myTitle = qs('#my-courses-title', nav);
    if(myTitle){
      const toggle = () => { state.ui.myCoursesExpanded = !state.ui.myCoursesExpanded; renderSidebar(); highlightActiveNav(); };
      myTitle.addEventListener('click', toggle);
      myTitle.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggle(); }});
    }
    qsa('[data-course-toggle]', nav).forEach(el=>{
      const cid = el.getAttribute('data-course-toggle');
      const toggle = () => { state.ui.courseExpanded[cid] = !state.ui.courseExpanded[cid]; renderSidebar(); highlightActiveNav(); };
      el.addEventListener('click', toggle);
      el.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggle(); }});
    });
    qsa('.course-sub-link', nav).forEach(a=>{
    a.addEventListener('click', (ev)=>{
  // Allow native navigation, do not prevent default
        const cid = a.getAttribute('data-course-id');
        const href = a.getAttribute('data-href');
        sessionStorage.setItem('currCourse', cid);
  // Highlight immediately to prevent flicker
    setTimeout(highlightActiveNav, 0);
  // Highlight immediately to prevent flicker
      });
    });
    qsa('[data-group]', nav).forEach(el=>{
      const gid = el.getAttribute('data-group');
      const toggle = () => { state.ui.groupExpanded[gid] = !state.ui.groupExpanded[gid]; renderSidebar(); highlightActiveNav(); };
      el.addEventListener('click', toggle);
      el.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggle(); }});
    });
    highlightActiveNav();
  }
  function highlightActiveNav(){
    const nav = qs('.sidebar .nav'); if(!nav) return;
    qsa('.nav a, .nav .nav-item', nav).forEach(el=>el.classList.remove('active'));
    const h = location.hash || '';
    const currCid = sessionStorage.getItem('currCourse');
    const pref = nav.querySelector(`a[href="${h}"]`); if(pref) pref.classList.add('active');
    const sub = nav.querySelector(`.course-sub-link[data-course-id="${currCid}"][data-href="${h}"]`);
    if(sub){
      sub.classList.add('active');
      const parent = sub.closest('.nav-group, #my-courses-box')?.querySelector(`.course-parent[data-course-toggle="${currCid}"]`);
      parent?.classList.add('active'); return;
    }
    if(h === '#/teacher/classroom' && currCid){
      nav.querySelector(`.course-parent[data-course-toggle="${currCid}"]`)?.classList.add('active');
    }
  }

  /************** Page Framework **************/
  function shell(content){
    return `
    <header class='topbar'>
      <div class='brand' onclick="goto('#/teacher/courses')" style='cursor:pointer'>
        <div class='logo'></div>
        <div>PolyClass</div>
      </div>
      <div class='top-actions'>
        <span>${state.user?.email||''}</span>
        <div class='avatar' onclick="goto('#/teacher/profile')" title='View Personal Info'></div>
      </div>
    </header>
    <div class='layout'>
      <aside class='sidebar'><nav class='nav' aria-label="Side Navigation"></nav></aside>
      <section class='content'>${content}</section>
    </div>`;
  }
  function updateSidebar(){ renderSidebar(); }

  /************** Login and Base Pages **************/
  function renderLogin(){
    mount(`
      <div class='center'>
        <div class='card login-panel'>
          <h2>Login to PolyClass</h2>
          <p class='muted'>Please select a role to login (currently only teacher portal is available).</p>
          <div class='grid cols-3' style='margin:12px 0'>
            <div class='role' data-role='teacher' tabindex="0" role="button" aria-pressed="true">Teacher</div>
            <div class='role' data-role='student' tabindex="0" role="button">Student</div>
            <div class='role' data-role='admin' tabindex="0" role="button">Admin</div>
          </div>
          <div style='display:flex;gap:10px;'>
            <input class='input' id='email' placeholder='Email' value='teacher@polyclass.edu' />
            <input class='input' id='pwd' placeholder='Password' type='password' value='123456' />
          </div>
          <div style='margin-top:16px;display:flex;justify-content:space-between;align-items:center'>
            <span class='muted'>Light Blue Theme · Teams Style</span>
            <button class='btn primary' id='login-btn'>Login</button>
          </div>
        </div>
      </div>
    `);
    let selectedRole = 'teacher';
    qsa('.role').forEach(el=>{
      const sel = ()=>{ qsa('.role').forEach(x=>x.classList.remove('active')); el.classList.add('active'); selectedRole = el.dataset.role; };
      el.addEventListener('click', sel);
      el.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); sel(); }});
    });
    qs(".role[data-role='teacher']")?.classList.add('active');
    qs('#login-btn')?.addEventListener('click', async ()=>{
      const email = qs('#email')?.value.trim();
      const password = qs('#pwd')?.value || '';
      if(!email || !password){ alert('Please enter email and password'); return; }
      // Simulate login
      state.user = { email, role: selectedRole, name: selectedRole === 'student' ? 'Student' : 'Teacher' };
      // If student, open the standalone student client page; otherwise go to teacher shell
      if(selectedRole === 'student'){
        // navigate to the student.html file in the same public folder
        window.location.href = 'student.html';
        return;
      }
      goto('#/teacher');
    });
  }
  function renderTeacherShell(){ goto('#/teacher/courses'); }

  // Teacher profile page (simple implementation to avoid undefined errors)
  function renderTeacherProfile(){
    const user = state.user || { name:'Teacher', email:'' };
    const html = `
      <h2>Personal Profile</h2>
      <div class='card' style='max-width:560px'>
        <div style='display:flex;align-items:center;gap:12px;margin-bottom:8px'>
          <div class='avatar' style='width:64px;height:64px;border-radius:12px'></div>
          <div>
            <div style='font-weight:700'>${escapeHTML(user.name||'Teacher')}</div>
            <div class='muted'>${escapeHTML(user.email||'')}</div>
          </div>
        </div>
        <div style='margin-top:12px'>
          <div class='muted'>Role</div>
          <div style='margin:6px 0 12px'>${escapeHTML(user.role||'teacher')}</div>
          <div style='display:flex;gap:8px'>
            <button class='btn' onclick="goto('#/teacher/courses')">Back to Courses</button>
            <button class='btn primary' onclick='(function(){ state.user=null; sessionStorage.removeItem("currCourse"); goto("#/login"); })()'>Logout</button>
          </div>
        </div>
      </div>
    `;
    mount(shell(html)); updateSidebar();
  }

  /************** Tabs & Header **************/
  function tabsHTML(activeKey){
    return `<div style='margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap'>
      ${TABS.map(t=>`<button class='btn ${t.key===activeKey?'primary':''}' data-href='${t.hash}'>${t.label}</button>`).join('')}
    </div>`;
  }
  function bindTabs(){ qsa('[data-href]').forEach(b=> b.addEventListener('click', ()=> goto(b.getAttribute('data-href')))); }
  function pageHeaderHTML(course, activeKey){
    const shared = !!course.public;
    return `
      <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:12px'>
        <div>
          <small class='muted'>Course / ${escapeHTML(course.id||'—')}</small>
          <h2 style='margin:4px 0 0 0'>${escapeHTML(course.title||course.id||'Unnamed Course')}</h2>
        </div>
        <div style='display:flex;gap:8px;align-items:center'>
          <label class='btn ghost' style='gap:6px'>
            <input id="share-toggle" type="checkbox" ${shared?'checked':''} style="accent-color:#3a82f6;transform:scale(1.1)"/>
            Share to Course Hall
          </label>
          <button class='btn' onclick="goto('#/teacher/courses')">Back to Course List</button>
          <button class='btn' onclick="copyJoinCode()">Copy Join Code</button>
        </div>
      </div>
      ${tabsHTML(activeKey)}
    `;
  }

  /************** Course List **************/
  async function renderCourses(){
    // Initialize courses (first time only)
    if(state.courses.length===0){
      state.courses = [
        {id:'CS101', title:'Computer Fundamentals', students:45, updated:'10-09', public:false, group:'Computer Science'},
        {id:'LING201', title:'Introduction to Semantics', students:60, updated:'10-08', public:true,  group:'Linguistics'},
        {id:'AI500', title:'AI Application Practice', students:38, updated:'10-07', public:false, group:'Computer Science'}
      ];
      state.sessions['CS101'] = [{ time:'2025-10-12 10:00', tag:'Class', text:'Lecture 4: C Basics' }];
      state.sessions['LING201'] = [{ time:'2025-10-13 09:00', tag:'Class', text:'Lecture 3: Semantic Roles' }];
      state.sessions['AI500'] = [{ time:'2025-10-12 14:00', tag:'Class', text:'Lecture 2: Data Cleaning' }];
    }
    const cards = (state.courses||[]).map(c=>`
      <div class='card'>
        <b>${escapeHTML(c.title||c.id||'Unnamed Course')}</b>
        <div class='muted'>ID: ${escapeHTML(c.id||'-')} · Students ${c.students ?? 0} · Updated ${escapeHTML(c.updated||'-')}</div>
        <div style='margin-top:8px;display:flex;gap:8px;align-items:center'>
          <button class='btn primary' onclick="openClassroom('${c.id}')">Enter Classroom</button>
          <span class='status ${c.public? 'on':'off'}'>${c.public? 'Public':'Private'}</span>
        </div>
      </div>`).join('');
    const html = `
      <h2>Courses</h2>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
        <div class="muted">Manage/Browse your courses</div>
        <div style="display:flex; gap:8px">
          <button class="btn">➕ Join Course</button>
          <button class="btn primary">➕ Create Course</button>
        </div>
      </div>
      <div class='grid cols-2'>${cards || '<div class="card">No courses</div>'}</div>`;
    mount(shell(html));
    updateSidebar();
  }
  function openClassroom(cid){
    if(!cid) return;
    sessionStorage.setItem('currCourse', cid);
    const h = location.hash || '';
    if(h.startsWith('#/teacher/classroom')) goto(h); else goto('#/teacher/classroom');
  }

  /************** Classroom Parent Page **************/
  async function renderClassroom(){
    let cid = sessionStorage.getItem('currCourse');
    if(!cid && state.courses.length){ cid = state.courses[0]?.id; sessionStorage.setItem('currCourse', cid); }
    const courseId = cid || '';
    const c = (state.courses.find(x=>x.id===courseId) || { id: courseId, title: courseId });

    // Example students/questions
    if(!state.students.length){
      state.students = [
        {id:'2025001', name:'Alice', status:'online', score:92, submissions:3},
        {id:'2025002', name:'Bob',   status:'offline', score:78, submissions:2},
      ];
    }
    if(!state.questions.length){
      state.questions = [
        {id:'q1', title:'Class Key Points Summary', deadlineISO:'2025-10-12T22:00'},
        {id:'q2', title:'Lecture 3 In-class Exercise', deadlineISO:'2025-10-14T18:00'}
      ];
    }

    const studentRows = (state.students||[]).map(s=>`
      <tr>
        <td>${escapeHTML(s.id||'-')}</td>
        <td>${escapeHTML(s.name||'-')}</td>
        <td><span class='status ${s.status==='online'?'on':'off'}'>${s.status==='online'?'Online':'Offline'}</span></td>
        <td>${s.score ?? '-'}</td>
        <td>${s.submissions ?? 0}</td>
        <td><button class='btn'>Details</button></td>
      </tr>`).join('');

    const inner = `
      ${pageHeaderHTML(c,'classroom')}
      <div class="classroom-grid">
        <div class='card'>
          <h3 style='margin-top:0'>Student Overview</h3>
          <table>
            <thead><tr><th>Student ID</th><th>Name</th><th>Status</th><th>Average Score</th><th>Submissions</th><th>Actions</th></tr></thead>
            <tbody>${studentRows || '<tr><td colspan="6" class="muted">No students</td></tr>'}</tbody>
          </table>
        </div>
        <aside class="activity-aside">
          <div class="mini-card">
            <div class="mini-title">🗳️ Polls</div>
            <div class="muted" style="margin-bottom:8px">Single / Multiple Choice</div>
            <div class="mini-actions">
              <button class="btn primary" onclick="alert('Poll creation not implemented yet')">Create Poll</button>
              <button class="btn" onclick="alert('Poll history not implemented yet')">History</button>
            </div>
          </div>
          <div class="mini-card">
            <div class="mini-title">📝 Q&A</div>
            <div class="muted" style="margin-bottom:8px">Short Answer / Word Cloud</div>
            <div class="mini-actions">
              <button class="btn primary" onclick="openQuestionModal()">New Q&A</button>
              <button class="btn" onclick="alert('Q&A history not implemented yet')">History</button>
            </div>
          </div>
          <div class="mini-card">
            <div class="mini-title">🎮 Mini Games</div>
            <div class="muted" style="margin-bottom:8px">Quick Answer / Leaderboard</div>
            <div class="mini-actions">
              <button class="btn primary" onclick="alert('Mini game creation not implemented yet')">Create Game</button>
              <button class="btn" onclick="alert('Mini game history not implemented yet')">History</button>
            </div>
          </div>
        </aside>
      </div>`;
    mount(shell(inner));
    updateSidebar();
    bindTabs();
    renderBottomDock(courseId);

    // 分享开关
    qs('#share-toggle')?.addEventListener('change', (e)=>{
      const checked = e.target.checked;
      const idx = state.courses.findIndex(x=>x.id===courseId);
      if(idx>=0){ state.courses[idx].public = checked; }
      updateSidebar();
    });
  }

  /************** Subpages: AI / Tools / Info **************/
  function renderSubpage(activeKey, bodyHTMLBuilder){
    const cid = sessionStorage.getItem('currCourse') || '';
    const c = state.courses.find(x=>x.id===cid) || { title: cid, id: cid };
    const inner = `${pageHeaderHTML(c,activeKey)}${bodyHTMLBuilder(c)}`;
    mount(shell(inner));
    updateSidebar();
    bindTabs();
  }
  function renderClassAI(){ renderSubpage('ai', ()=>`
    <div class='grid cols-2'>
      <div class='card'>
        <h3 style='margin-top:0'>🧭 Auto Lesson Planning</h3>
        <div class='muted'>Quickly generate teaching outlines, key points, and activity suggestions based on teaching objectives and materials.</div>
        <div style='display:flex;gap:8px;margin-top:12px'>
          <input class='input' id='plan-topic' placeholder='Enter lesson topic/material link'/>
          <button class='btn primary' onclick="alert('Example: Lesson plan draft generated (API empty, can connect to backend)')">Generate Plan</button>
        </div>
      </div>
      <div class='card'>
        <h3 style='margin-top:0'>✏️ Auto Question Generation</h3>
        <div class='muted'>Extract multiple choice and short answer questions from textbooks/slides, with difficulty and quantity settings.</div>
        <div style='display:flex;gap:8px;margin-top:12px;flex-wrap:wrap'>
          <input class='input' style='max-width:220px' id='q-count' placeholder='Question count (e.g. 10)'/>
          <select class='input' style='max-width:220px' id='q-level'>
            <option value='easy'>Easy</option><option value='mid'>Medium</option><option value='hard'>Hard</option>
          </select>
          <button class='btn primary' onclick="alert('Example: Questions generated (API empty, can connect to backend)')">Generate Questions</button>
        </div>
      </div>
      <div class='card'><h3 style='margin-top:0'>🧾 Summarize Course Info</h3><div class='muted'>Automatically summarize key points, common errors, and improvement suggestions.</div><button class='btn primary' style='margin-top:8px' onclick="alert('Example: Course summary generated')">Generate Summary</button></div>
      <div class='card'><h3 style='margin-top:0'>🔁 One-Click Publish</h3><div class='muted'>Push lesson plans/questions/summaries to discussion or Q&A module.</div><button class='btn' style='margin-top:8px' onclick="alert('Example: Pushed to discussion area')">Push to Discussion</button></div>
    </div>`); }

  function renderCourseTools(){ renderSubpage('tools', ()=>`
    <div class='grid cols-2'>
      <div class='card'>
        <h3 style='margin-top:0'>📢 Create Poll</h3>
        <div class='muted'>Quick create single/multiple choice polls and push to real-time discussion.</div>
        <button class='btn primary' onclick="alert('Placeholder: Create Poll')">Create Poll</button>
      </div>
      <div class='card'>
        <h3 style='margin-top:0'>📘 Assign Homework</h3>
        <div class='muted'>Set homework with deadline, automatically enters schedule-homework view.</div>
        <button class='btn primary' onclick="quickCreateAssignment()">Assign Homework</button>
      </div>
      <div class='card'>
        <h3 style='margin-top:0'>🧪 Create Quiz</h3>
        <div class='muted'>Create quiz with automatic grading for objective questions.</div>
        <button class='btn primary' onclick="alert('Placeholder: Create Quiz')">Create Quiz</button>
      </div>
      <div class='card'>
        <h3 style='margin-top:0'>❓ Create Q&A</h3>
        <div class='muted'>Quickly create Q&A topics, automatically appears in bottom Q&A bar.</div>
        <button class='btn primary' onclick="openQuestionModal()">Create Q&A</button>
      </div>
      <div class='card'>
        <h3 style='margin-top:0'>🧩 Multiple Choice Activity</h3>
        <div class='muted'>Start multiple choice interactive questions with real-time statistics visualization.</div>
        <button class='btn primary' onclick="alert('Placeholder: Start Activity')">Start Activity</button>
      </div>
      <div class='card'>
        <h3 style='margin-top:0'>🎮 Mini Game Activity</h3>
        <div class='muted'>Quick answer / leaderboard and other classroom mini games.</div>
        <button class='btn primary' onclick="alert('Placeholder: Start Game')">Start Game</button>
      </div>
    </div>`); }
  function quickCreateAssignment(){
    const cid = sessionStorage.getItem('currCourse') || '';
  const ttl = 'Homework: Read Chapter 4 and complete exercises';
    const ddl = new Date(Date.now()+2*24*3600*1000);
    state.questions.push({id:'hw-'+Date.now(), title:ttl, deadlineISO: toLocalDatetimeValue(ddl)});
  alert('Homework created and added to timeline (assignments)');
    goto('#/teacher/classroom/timeline');
    state.ui.timelineFilter = 'assignment';
  }
  function renderCourseInsights(){ renderSubpage('insights', ()=>`
    <div class='grid cols-3'>
      <div class='card'><b>This Week's Engagement</b></div>
      <div class='card'><b>Average Accuracy</b></div>
      <div class='card'><b>Submission Distribution</b></div>
    </div>`); }

  /************** 讨论区：实时+帖子 **************/
  function ensureDiscussion(cid){
    if(!state.discussions[cid]){
      state.discussions[cid] = {
        chatMessages:[
          {id:1, role:'teacher', name:'Teacher', text:'Hello everyone, class is starting!', time:fmtDeadline(new Date().toISOString())},
          {id:2, role:'student', name:'Alice', text:'Received, teacher', time:fmtDeadline(new Date().toISOString())}
        ],
        posts:{ teacher:[], student:[] }
      };
    }
    return state.discussions[cid];
  }
  function renderClassDiscuss(){
    const cid = sessionStorage.getItem('currCourse') || '';
    const c = state.courses.find(x=>x.id===cid) || { title: cid, id: cid };
    const d = ensureDiscussion(cid);

  // To avoid template parsing issues with nested backticks, build the messages list string first
    const messagesHTML = (d.chatMessages || []).map(m => {
      return '<div class="msg ' + (m.role==='teacher' ? 'me' : '') + '">' +
        '<div class="bubble"><b>' + escapeHTML(m.name) + '：</b>' + escapeHTML(m.text) + '<div class="muted" style="font-size:12px">' + escapeHTML(m.time) + '</div></div>' +
      '</div>';
    }).join('');

    const chatHTML = `
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <b>Live Discussion</b>
          <div class="muted">Like a group chat: visible to everyone</div>
        </div>
        <div class="chat-box">
          <div id="chat-scroll" class="chat-scroll">
            ${messagesHTML}
          </div>
          <div class="chat-input">
            <input id="chat-input" class="input" placeholder="Type a message and press Enter to send"/>
            <button class="btn primary" id="chat-send">Send</button>
          </div>
        </div>
      </div>
    `;
    const postCard = (p)=>`
      <div class="card">
        <b>${escapeHTML(p.title)}</b>
        <div class="muted" style="margin-top:6px">${escapeHTML(p.content||'')}</div>
  <div class="muted" style="margin-top:6px;font-size:12px">Author: ${escapeHTML(p.author||'—')} · ${escapeHTML(p.time||'')}</div>
      </div>
    `;
    const postsHTML = `
      <div class="grid cols-2">
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <b>Post Discussions (Teacher Posts)</b>
            <button class="btn" onclick="openPostEditor('teacher')">+ New</button>
          </div>
          ${d.posts.teacher.map(postCard).join('') || '<div class="card">No teacher posts</div>'}
        </div>
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <b>Post Discussions (Student Posts)</b>
            <button class="btn" onclick="openPostEditor('student')">+ New</button>
          </div>
          ${d.posts.student.map(postCard).join('') || '<div class="card">No student posts</div>'}
        </div>
      </div>
    `;
    const inner = `
      ${pageHeaderHTML(c,'discuss')}
      <div class="segmented" style="margin-bottom:12px">
        <button class="seg-btn active" data-panel="chat">Live Discussion</button>
        <button class="seg-btn" data-panel="posts">Posts</button>
      </div>
      <div id="panel-chat">${chatHTML}</div>
      <div id="panel-posts" style="display:none">${postsHTML}</div>
    `;
    mount(shell(inner));
    updateSidebar();
    bindTabs();

  // Switch panels
    qsa('.seg-btn').forEach(b=>{
      b.addEventListener('click', ()=>{
        qsa('.seg-btn').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        const p = b.getAttribute('data-panel');
        qs('#panel-chat').style.display = (p==='chat')?'block':'none';
        qs('#panel-posts').style.display = (p==='posts')?'block':'none';
      });
    });
  // Send chat
    const send = ()=>{
      const ipt = qs('#chat-input'); if(!ipt) return;
      const txt = (ipt.value||'').trim(); if(!txt) return;
      const msg = {id:Date.now(), role:'teacher', name:'Teacher', text:txt, time:fmtDeadline(new Date().toISOString())};
      d.chatMessages.push(msg);
      renderClassDiscuss();
      setTimeout(()=>{ const sc=qs('#chat-scroll'); if(sc){ sc.scrollTop=sc.scrollHeight; } },0);
    };
    qs('#chat-send')?.addEventListener('click', send);
    qs('#chat-input')?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ send(); } });
  }
  function openPostEditor(role){
    const cid = sessionStorage.getItem('currCourse') || '';
    const d = ensureDiscussion(cid);
    const body = qs('#modal-body'), title = qs('#modal-title'), save = qs('#modal-save');
    title.textContent = `New Post (${role==='teacher'?'Teacher':'Student'})`;
    body.innerHTML = `
      <label><div class="muted">Title</div><input id="post-title" class="input" placeholder="Enter title (required)"/></label>
      <label><div class="muted">Content</div><textarea id="post-content" class="input" rows="4" placeholder="Enter content"></textarea></label>
    `;
    save.onclick = ()=>{
      const t = qs('#post-title')?.value.trim(); const c = qs('#post-content')?.value.trim();
  if(!t){ alert('Please enter a title'); return; }
      const post = { title:t, content:c, time:fmtDeadline(new Date().toISOString()), author: role==='teacher'?'Teacher':'Student' };
      d.posts[role].unshift(post);
      closeModal(); renderClassDiscuss();
    };
    qs('#modal-mask').style.display='flex';
  }

  /************** 时间表：过滤与日历式 **************/
  function renderClassTimeline(){
    const cid = sessionStorage.getItem('currCourse') || '';
    const c = state.courses.find(x=>x.id===cid) || { title: cid, id: cid };
    const sessions = state.sessions[cid] || [];
    const assignments = (state.questions||[])
      .filter(q=>q.deadlineISO).map(q=>({ time: (q.deadlineISO||'').replace('T',' '), tag:'Assignment', text:`${q.title}` }));

    const filter = state.ui.timelineFilter || 'all';
    const items = [
      ...(filter!=='assignment' ? sessions : []),
      ...(filter!=='class' ? assignments : [])
    ].sort((a,b)=> (a.time||'').localeCompare(b.time||''));

    const groups = {};
    items.forEach(i=>{
  const d = (i.time||'').slice(0,10) || 'Ungrouped';
      if(!groups[d]) groups[d]=[];
      groups[d].push(i);
    });

    const calendarHTML = Object.keys(groups).sort().map(day=>`
      <div class="calendar-day">${escapeHTML(day)}</div>
      ${groups[day].map(i=>`
        <div class="calendar-item">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <b>${escapeHTML(i.text||'')}</b>
            <span class="status ${i.tag==='Assignment'?'off':'on'}">${escapeHTML(i.tag||'')}</span>
          </div>
          <div class="muted" style="margin-top:6px">${escapeHTML(i.time||'')}</div>
        </div>
      `).join('')}
  `).join('') || '<div class="card">No schedule</div>';

    const filterBar = `
      <div class="filter-row">
        <span class='muted'>Filter:</span>
        <button class="btn ${filter==='all'?'primary':''}" data-filter="all">All</button>
        <button class="btn ${filter==='class'?'primary':''}" data-filter="class">Class Times</button>
        <button class="btn ${filter==='assignment'?'primary':''}" data-filter="assignment">Assignments</button>
      </div>
    `;
    const inner = `${pageHeaderHTML(c,'timeline')}${filterBar}<div>${calendarHTML}</div>`;
    mount(shell(inner));
    updateSidebar();
    bindTabs();
    qsa('[data-filter]').forEach(b=>{
      b.addEventListener('click', ()=>{
        state.ui.timelineFilter = b.getAttribute('data-filter');
        renderClassTimeline();
      });
    });
  }

  /************** 底部问答 Chips **************/
  function renderBottomDock(courseId){
    qs('#bottom-dock')?.remove();
    const list = state.questions || [];
    if(list.length === 0) return;
    const dock = document.createElement('div');
    dock.id = 'bottom-dock';
    dock.className = 'bottom-dock';
    dock.innerHTML = list.map(q => `
      <div class="question-chip" onclick="openQuestionModal('${q.id}')">
        <strong>Q:</strong> <span>${escapeHTML(q.title||'—')}</span>
        ${q.deadlineISO ? `<span class="deadline">· Due ${fmtDeadline(q.deadlineISO)}</span>` : ''}
      </div>`).join('');
    document.body.appendChild(dock);
  }

  /************** 问答弹窗（复用通用弹窗） **************/
  let editingQuestionId = null;
  function openQuestionModal(id=null){
    editingQuestionId = id;
    const body = qs('#modal-body'), title = qs('#modal-title'), save = qs('#modal-save');
  title.textContent = id?'Edit Q&A':'New Q&A';
    const q = (state.questions || []).find(x=>x.id===id) || {};
    body.innerHTML = `
      <label><div class="muted">Question Title</div><input id="q-title" class="input" placeholder="Enter question title (required)" value="${escapeHTML(q.title||'')}" /></label>
      <label><div class="muted">Details</div><textarea id="q-desc" class="input" rows="4" placeholder="Add background or answer requirements">${escapeHTML(q.desc||'')}</textarea></label>
  <label><div class="muted">Deadline</div><input id="q-deadline" class="input" type="datetime-local" value="${q.deadlineISO||toLocalDatetimeValue(new Date(Date.now()+3600000))}"/></label>
    `;
    save.onclick = saveQuestion;
    qs('#modal-mask').style.display='flex';
  }
  function closeModal(ev){
    if(ev && ev.target && ev.target.id && ev.target.id !== 'modal-mask') return;
    const mask = qs('#modal-mask'); if(mask) mask.style.display = 'none';
    editingQuestionId = null;
  }
  async function saveQuestion(){
    const cid = sessionStorage.getItem('currCourse');
    const title = qs('#q-title')?.value.trim();
    const desc  = qs('#q-desc')?.value.trim();
    const ddl   = qs('#q-deadline')?.value;
  if(!title){ alert('Please enter a question title'); return; }
    if(editingQuestionId){
      const idx = state.questions.findIndex(q=>q.id===editingQuestionId);
      const updated = { id:editingQuestionId, title, desc, deadlineISO: ddl||'' };
      if(idx>=0) state.questions[idx] = updated;
    }else{
      const created = { id:'q'+Date.now(), title, desc, deadlineISO: ddl||'' };
      state.questions.push(created);
    }
    closeModal(); renderBottomDock(cid);
  }

  /************** 课程大厅（展示课可编辑） **************/
  function renderHall(){
    const livePublics = (state.courses||[]).filter(c=>c.public);
    const showcase = state.showcase || [];
    const card = c=>`
      <div class='card'>
        <div style='display:flex;gap:10px;align-items:center'>
          <img src='https://picsum.photos/seed/${encodeURIComponent(c.id)}/120/80' style='width:120px;height:80px;border-radius:8px;object-fit:cover' alt='thumb'/>
          <div style='flex:1'>
            <b>${escapeHTML(c.title||c.id||'Unnamed Course')}</b>
            <div class='muted' style='margin-top:6px'>${escapeHTML(c.desc || 'No description')}</div>
            <div style='margin-top:8px;display:flex;gap:8px;align-items:center'>
              <button class='btn primary' onclick="openClassroom('${c.id}')">View Course</button>
              <span class='muted'>${escapeHTML(c.teacher||'Teacher')} · ${c.students||0} students</span>
              <span style='margin-left:auto' class='status ${c.public? 'on':'off'}'>${c.public? 'Public':'Showcase'}</span>
            </div>
          </div>
        </div>
      </div>`;
    const manageTable = `
      <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
          <b>Showcase Courses (editable, for demo only)</b>
          <button class="btn primary" onclick="openShowcaseEditor()">+ Add Showcase Course</button>
        </div>
        <table class="table" style="margin-top:10px">
          <thead><tr><th>ID</th><th>Title</th><th>Teacher</th><th>Students</th><th>Actions</th></tr></thead>
          <tbody>
            ${showcase.map((s,i)=>`
              <tr>
                <td>${escapeHTML(s.id)}</td>
                <td>${escapeHTML(s.title)}</td>
                <td>${escapeHTML(s.teacher||'')}</td>
                <td>${s.students||0}</td>
                <td>
                  <button class="btn" onclick="openShowcaseEditor(${i})">Edit</button>
                  <button class="btn" onclick="deleteShowcase(${i})">Delete</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
    const html = `
      <h2>Course Hall</h2>
      <div class='grid cols-2' style='margin-top:12px'>
        ${(livePublics.map(card).join('')) || '<div class="card">No public courses</div>'}
        ${(showcase.map(card).join('')) || ''}
      </div>
      ${manageTable}
    `;
    mount(shell(html)); updateSidebar();
  }
  function openShowcaseEditor(idx=null){
    const body = qs('#modal-body'), title = qs('#modal-title'), save = qs('#modal-save');
  const data = (idx!==null)? state.showcase[idx] : {id:'show-'+Date.now(), title:'', teacher:'', students:0, public:true, desc:''};
  title.textContent = (idx!==null)? 'Edit Showcase Course' : 'Add Showcase Course';
    body.innerHTML = `
  <label><div class="muted">ID</div><input id="sc-id" class="input" value="${escapeHTML(data.id)}" ${idx!==null?'readonly':''}/></label>
  <label><div class="muted">Title</div><input id="sc-title" class="input" value="${escapeHTML(data.title)}"/></label>
  <label><div class="muted">Teacher</div><input id="sc-teacher" class="input" value="${escapeHTML(data.teacher||'')}"/></label>
  <label><div class="muted">Students</div><input id="sc-students" type="number" class="input" value="${data.students||0}"/></label>
  <label><div class="muted">Description</div><textarea id="sc-desc" class="input" rows="3">${escapeHTML(data.desc||'')}</textarea></label>
    `;
    save.onclick = ()=>{
      const id = qs('#sc-id').value.trim();
        const item = {
        id,
        title: qs('#sc-title').value.trim() || 'Unnamed Course',
        teacher: qs('#sc-teacher').value.trim()||'Teacher',
        students: parseInt(qs('#sc-students').value||'0',10),
        desc: qs('#sc-desc').value.trim(),
        public:true
      };
      if(idx!==null) state.showcase[idx]=item; else state.showcase.unshift(item);
      closeModal(); renderHall();
    };
    qs('#modal-mask').style.display='flex';
  }
  function deleteShowcase(idx){
  if(!confirm('Confirm delete this showcase course?')) return;
    state.showcase.splice(idx,1);
    renderHall();
  }

  /************** 会议/其他 **************/
  function renderMeeting(){
    const html = `
      <div class='card'>
  <h3>Video Meeting (placeholder)</h3>
  <p class='muted'>Zoom / WebRTC integration will be added here in the future.</p>
        <div style='margin-top:12px;display:flex;gap:8px'>
          <button class='btn primary' onclick="alert('Placeholder: will open video meeting (future implementation)')">Start Meeting (placeholder)</button>
          <button class='btn' onclick="alert('Placeholder: meeting settings (future implementation)')">Meeting Settings</button>
        </div>
      </div>`;
    mount(shell(html)); updateSidebar();
  }
  function renderAIStudio(){
  const html = `<h2>AI Assistant</h2><div class='grid cols-2'><div class='card'><b>Generate Questions from Materials</b></div><div class='card'><b>Cluster Similar Answers</b></div></div>`;
    mount(shell(html)); updateSidebar();
  }
  function renderInsights(){
  const html = `<h2>Insights</h2><div class='grid cols-3'><div class='card'><b>Student Engagement</b></div><div class='card'><b>Average Accuracy</b></div><div class='card'><b>Submission Timing</b></div></div>`;
    mount(shell(html)); updateSidebar();
  }

  /************** Routes **************/
  function route(){
    removeFloatingUI();
    let h = location.hash || '';
    if(!h){
  // If there's no hash, determine the default route and update the URL immediately,
  // Render the target page immediately (don't rely only on the hashchange event),
  // This prevents blank pages during load when hashchange may not fire promptly in some environments.
      const target = state.user ? '#/teacher/courses' : '#/login';
      // 更新地址栏
      location.hash = target;
      // 立即渲染目标页面以保证页面可见
      (routes[target] || renderLogin)();
      setTimeout(updateSidebar, 0);
      return;
    }
    (routes[h] || renderLogin)();
    setTimeout(updateSidebar, 0);
  }

  /************** Copy Join Code (fallback) **************/
  async function copyJoinCode(){
    const cid = sessionStorage.getItem('currCourse');
    const code = cid ? `JOIN-${cid}` : 'JOIN-CODE';
    try{
      if(navigator.clipboard?.writeText){ await navigator.clipboard.writeText(code); alert('Join code copied: ' + code); }
      else{ prompt('Copy the join code below:', code); }
    }catch(e){ alert('Copy failed: ' + (e?.message||e)); }
  }

  /************** Startup **************/
  document.addEventListener('DOMContentLoaded', ()=>{
    window.addEventListener('hashchange', route);
    route();
  });
  </script>
</body>
</html>