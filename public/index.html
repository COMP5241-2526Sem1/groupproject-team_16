<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PolyClass 教师端原型</title>
  <style>
    :root{
      --bg:#f5f9ff; --panel:#e6f0ff; --card:#ffffff; --border:#bcd2f0; --muted:#557aa3;
      --text:#0a1f33; --primary:#3a82f6; --primary-2:#60a5fa; --accent:#22d3ee;
      --ok:#16a34a; --warn:#f59e0b; --danger:#dc2626; --sidebar-width:220px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC",sans-serif}
    a{color:inherit;text-decoration:none}
    .btn{display:inline-flex;gap:8px;align-items:center;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--panel);cursor:pointer;transition:background .2s}
    .btn.primary{background:linear-gradient(90deg,var(--primary),var(--primary-2));border:0;color:#fff;font-weight:700}
    .btn:hover{background:var(--primary-2);color:#fff}
    .input,select,textarea{padding:12px 14px;border-radius:10px;border:1px solid var(--border);background:#fff;color:var(--text);width:100%}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 2px 4px rgba(0,0,0,.05)}
    .grid{display:grid;gap:16px}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
    .status{padding:4px 8px;border-radius:999px;font-size:12px}
    .on{background:#dcfce7;color:#166534}
    .off{background:#fee2e2;color:#991b1b}
    .topbar{position:fixed;left:0;right:0;top:0;height:56px;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:20}
    .brand{display:flex;gap:10px;align-items:center;font-weight:700;font-size:18px}
    .brand .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#60a5fa,#22d3ee)}
    .top-actions{display:flex;gap:10px;align-items:center}
    .avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#3b82f6,#06b6d4);cursor:pointer;border:2px solid #fff}
    .layout{display:flex;margin-top:56px;min-height:calc(100vh - 56px)}
    .sidebar{width:var(--sidebar-width);background:var(--panel);border-right:1px solid var(--border);padding:12px;display:flex;flex-direction:column;gap:8px}
    .nav a{padding:10px 12px;border-radius:8px;display:flex;align-items:center;gap:10px;color:var(--muted);transition:background .2s;cursor:pointer}
    .nav a.active,.nav a:hover{background:var(--primary-2);color:#fff}
    .content{flex:1;padding:18px;overflow:auto}
    .center{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .login-panel{max-width:560px;width:100%}
    .role{flex:1;padding:14px;border-radius:12px;border:1px solid var(--border);background:#fff;text-align:center;cursor:pointer}
    .role.active{outline:2px solid var(--primary)}
    .classroom-grid{display:grid;grid-template-columns: 1fr 320px;gap:16px;align-items:start}
    .activity-aside{position:sticky;top:86px;display:flex;flex-direction:column;gap:10px}
    .activity-aside .mini-card{padding:12px;border-radius:14px;border:1px solid var(--border);background:var(--card);box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .mini-title{font-weight:700;margin-bottom:4px}
    .mini-actions{display:flex;gap:8px;flex-wrap:wrap}
    .bottom-dock{position:fixed;left: calc(var(--sidebar-width) + 18px);right:18px;bottom:16px;z-index:14;display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap}
    .question-chip{background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px 12px;box-shadow:0 2px 6px rgba(0,0,0,.05);display:flex;gap:8px;align-items:center;cursor:pointer}
    .deadline{font-size:12px;color:var(--muted)}
    .modal-mask{position:fixed;inset:0;background:rgba(10,31,51,.35);display:none;align-items:center;justify-content:center;z-index:30}
    .modal{width:min(680px,92vw);background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 12px 30px rgba(0,0,0,.2)}
    .modal header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .modal footer{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}

    /* 新增：课程子导航样式 */
    .subnav{margin:6px 0 4px 10px;display:flex;flex-direction:column;gap:4px}
    .subnav a{padding:8px 12px 8px 28px;border-radius:8px;color:var(--muted)}
    .subnav a.active,.subnav a:hover{background:var(--primary-2);color:#fff}
    .nav .parent{display:flex;align-items:center;justify-content:space-between}
    .nav .caret{font-size:12px;opacity:.8}

    @media(max-width:980px){
      .grid.cols-3{grid-template-columns:repeat(2,1fr)}
      .sidebar{width:auto;flex-direction:row;border-right:0;border-bottom:1px solid var(--border)}
      .content{padding:12px}
      .classroom-grid{grid-template-columns:1fr}
      .activity-aside{position:static}
      .bottom-dock{left:12px;right:12px}
    }
  </style>
</head>
<body>
  <main id="app"></main>

  <!-- 问答编辑弹窗 -->
  <div id="modal-mask" class="modal-mask" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <header>
        <h3 id="modal-title" style="margin:0">新建问答</h3>
        <button class="btn" onclick="closeModal()">✖</button>
      </header>
      <div style="display:flex;flex-direction:column;gap:10px">
        <label><div class="muted">问题标题</div><input id="q-title" class="input" placeholder="请输入问题标题（必填）"/></label>
        <label><div class="muted">详细说明</div><textarea id="q-desc" class="input" rows="4" placeholder="可补充背景、答题要求等"></textarea></label>
        <label><div class="muted">截止时间</div><input id="q-deadline" class="input" type="datetime-local"/></label>
      </div>
      <footer>
        <button class="btn" onclick="closeModal()">取消</button>
        <button class="btn primary" onclick="saveQuestion()">保存</button>
      </footer>
    </div>
  </div>

  <script>
    const API_BASE = ''; // 同域部署，留空即可。如跨域可改为 'http://localhost:3000'
    const state = {
      user: null,
      courses: [],
      students: [],
      questions: [], // 当前课程的问答
      joinCode: ''
    };

    /* 路由：新增三个课程子页 */
    const routes = {
      '#/login': renderLogin,
      '#/teacher': renderTeacherShell,
      '#/teacher/profile': renderTeacherProfile,
      '#/teacher/courses': renderCourses,
      '#/teacher/classroom': renderClassroom,              // 进入课堂（原）
      '#/teacher/classroom/ai': renderClassAI,             // 新：AI 助手
      '#/teacher/classroom/discuss': renderClassDiscuss,   // 新：讨论区
      '#/teacher/classroom/timeline': renderClassTimeline, // 新：时间表
      '#/teacher/ai': renderAIStudio,                      // 全局实验室（保留）
      '#/teacher/insights': renderInsights
    };

    function mount(html){ document.getElementById('app').innerHTML = html; }
    function goto(hash){ location.hash = hash; }
    function removeFloatingUI(){
      document.getElementById('bottom-dock')?.remove();
      const mask = document.getElementById('modal-mask');
      if(mask) mask.style.display = 'none';
    }

    // ---- API helpers ----
    async function api(path, options={}){
      const res = await fetch(API_BASE + path, {
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        ...options
      });
      if(!res.ok){
        const t = await res.json().catch(()=>({message: res.statusText}));
        throw new Error(t.message || `HTTP ${res.status}`);
      }
      return res.json();
    }

    // ---- 登录页 ----
    function renderLogin(){
      mount(`
        <div class='center'>
          <div class='card login-panel'>
            <h2>登录 PolyClass</h2>
            <p class='muted'>请选择角色登录（当前仅开放教师端）。</p>
            <div class='grid cols-3' style='margin:12px 0'>
              <div class='role' data-role='teacher'>教师</div>
              <div class='role' data-role='student'>学生</div>
              <div class='role' data-role='admin'>管理员</div>
            </div>
            <div style='display:flex;gap:10px;'>
              <input class='input' id='email' placeholder='邮箱' value='teacher@polyclass.edu'/>
              <input class='input' id='pwd' placeholder='密码' type='password' value='123456'/>
            </div>
            <div style='margin-top:16px;display:flex;justify-content:space-between;align-items:center'>
              <span class='muted'>轻蓝主题 · Teams风格</span>
              <button class='btn primary' id='login-btn'>登录</button>
            </div>
          </div>
        </div>
      `);
      let selectedRole = 'teacher';
      document.querySelectorAll('.role').forEach(el=>{
        el.addEventListener('click',()=>{
          document.querySelectorAll('.role').forEach(x=>x.classList.remove('active'));
          el.classList.add('active'); selectedRole = el.dataset.role;
        });
      });
      document.querySelector(".role[data-role='teacher']").classList.add('active');

      document.getElementById('login-btn').addEventListener('click', async ()=>{
        try{
          const email = document.getElementById('email').value.trim();
          const password = document.getElementById('pwd').value;
          const data = await api('/api/login', {
            method:'POST',
            body: JSON.stringify({ email, password, role: selectedRole })
          });
          state.user = data.user;
          goto('#/teacher');
        }catch(e){
          alert('登录失败：' + e.message);
        }
      });
    }

    function selectRole(r){ sessionStorage.setItem('role', r); }

    /* 侧边栏：课程主栏 + 子项（AI/讨论区/时间表） */
    function shell(content, active){
      const hasCourse = !!sessionStorage.getItem('currCourse');
      const subActive = location.hash.startsWith('#/teacher/classroom')
        ? location.hash : null;

      const courseTitle = (() => {
        const cid = sessionStorage.getItem('currCourse');
        if(!cid) return '';
        const c = state.courses.find(x=>x.id===cid);
        return c ? `${c.title}` : `课程 ${cid}`;
      })();

      return `
      <header class='topbar'>
        <div class='brand' onclick="goto('#/teacher/courses')" style='cursor:pointer'>
          <div class='logo'></div>
          <div>PolyClass</div>
        </div>
        <div class='top-actions'>
          <span>${state.user?.email||''}</span>
          <div class='avatar' onclick="goto('#/teacher/profile')" title='查看个人信息'></div>
        </div>
      </header>
      <div class='layout'>
        <aside class='sidebar'>
          <nav class='nav'>
            <a class='${active==='courses'?'active':''} parent' onclick="goto('#/teacher/courses')">
              <span>📚 课程</span>
              <span class='caret'>${hasCourse ? '▼' : ''}</span>
            </a>

            ${hasCourse ? `
              <div class="subnav">
                <a class='${subActive==='#/teacher/classroom'?'active':''}'
                   onclick="goto('#/teacher/classroom')">🏫 进入课堂 · ${courseTitle}</a>
                <a class='${subActive==='#/teacher/classroom/ai'?'active':''}'
                   onclick="goto('#/teacher/classroom/ai')">🤖 AI 助手</a>
                <a class='${subActive==='#/teacher/classroom/discuss'?'active':''}'
                   onclick="goto('#/teacher/classroom/discuss')">💬 讨论区</a>
                <a class='${subActive==='#/teacher/classroom/timeline'?'active':''}'
                   onclick="goto('#/teacher/classroom/timeline')">🗓️ 时间表</a>
              </div>
            `:''}

            <a class='${active==='ai'?'active':''}' onclick="goto('#/teacher/ai')">🧪 实验室（全局）</a>
            <a class='${active==='insights'?'active':''}' onclick="goto('#/teacher/insights')">📈 信息展示</a>
          </nav>
        </aside>
        <section class='content'>${content}</section>
      </div>`;
    }

    function renderTeacherShell(){ goto('#/teacher/courses'); }

    function renderTeacherProfile(){
      const html = `<div class='card'><h3>个人信息</h3><p>姓名：${state.user?.name||'—'}</p><p>邮箱：${state.user?.email||'—'}</p><p>角色：${state.user?.role||'—'}</p><button class='btn primary' onclick="goto('#/login')">退出登录</button></div>`;
      mount(shell(html,'profile'));
    }

    // ---- 课程页 ----
    async function renderCourses(){
      try{
        const { data } = await api('/api/courses');
        state.courses = data;
      }catch(e){
        alert('获取课程失败：' + e.message);
      }

      const cards = state.courses.map(c=>`
        <div class='card'>
          <b>${c.title}</b>
          <div class='muted'>编号：${c.id} · 学生 ${c.students} · 更新 ${c.updated}</div>
          <div style='margin-top:8px'>
            <button class='btn primary' onclick="openClassroom('${c.id}')">进入课堂</button>
          </div>
        </div>`).join('');

      const html = `<h2>课程</h2>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
        <div class="muted">管理/浏览你的课程</div>
        <div style="display:flex; gap:8px">
          <button class="btn">➕ 加入课程</button>
          <button class="btn primary">➕ 新建课程</button>
        </div>
      </div>
      <div class='grid cols-2'>${cards}</div>`;
      mount(shell(html,'courses'));
    }

    function openClassroom(cid){
      sessionStorage.setItem('currCourse', cid);
      goto('#/teacher/classroom');
    }

    // ---- 课堂页（原） ----
    async function renderClassroom(){
      const cid = sessionStorage.getItem('currCourse');
      if(!cid && state.courses.length) sessionStorage.setItem('currCourse', state.courses[0].id);
      const courseId = sessionStorage.getItem('currCourse') || '';

      // 并发获取学生/问题/加入码
      try{
        const [stuRes, qRes, joinRes] = await Promise.all([
          api(`/api/courses/${courseId}/students`),
          api(`/api/courses/${courseId}/questions`),
          api(`/api/courses/${courseId}/join-code`)
        ]);
        state.students = stuRes.data;
        state.questions = qRes.data;
        state.joinCode = joinRes.code;
      }catch(e){
        alert('加载课堂数据失败：' + e.message);
      }

      const c = (state.courses.find(x=>x.id===courseId) || { id: courseId, title: courseId });

      const studentRows = state.students.map(s=>`
        <tr>
          <td>${s.id}</td>
          <td>${s.name}</td>
          <td><span class='status ${s.status==='online'?'on':'off'}'>${s.status==='online'?'在线':'离线'}</span></td>
          <td>${s.score}</td>
          <td>${s.submissions}</td>
          <td><button class='btn'>详情</button></td>
        </tr>
      `).join('');

      const html = `
        <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:12px'>
          <div>
            <small class='muted'>课堂 / ${c.id}</small>
            <h2 style='margin:4px 0 0 0'>${c.title}</h2>
          </div>
          <div style='display:flex;gap:8px'>
            <button class='btn' onclick="goto('#/teacher/courses')">返回课程列表</button>
            <button class='btn' onclick="copyJoinCode()">复制加入码</button>
          </div>
        </div>

        <div class="classroom-grid">
          <div class='card'>
            <h3 style='margin-top:0'>学生概览</h3>
            <table>
              <thead><tr><th>学号</th><th>姓名</th><th>状态</th><th>平均分</th><th>提交次数</th><th>操作</th></tr></thead>
              <tbody>${studentRows}</tbody>
            </table>
          </div>

          <aside class="activity-aside">
            <div class="mini-card">
              <div class="mini-title">🗳️ 投票</div>
              <div class="muted" style="margin-bottom:8px">单选 / 多选</div>
              <div class="mini-actions">
                <button class="btn primary" onclick="alert('投票创建暂未实现')">新建投票</button>
                <button class="btn" onclick="alert('投票历史暂未实现')">历史记录</button>
              </div>
            </div>
            <div class="mini-card">
              <div class="mini-title">📝 问答</div>
              <div class="muted" style="margin-bottom:8px">简答 / 词云</div>
              <div class="mini-actions">
                <button class="btn primary" onclick="openQuestionModal()">新建问答</button>
                <button class="btn" onclick="alert('问答历史暂未实现')">历史记录</button>
              </div>
            </div>
            <div class="mini-card">
              <div class="mini-title">🎮 小游戏</div>
              <div class="muted" style="margin-bottom:8px">抢答 / 排行榜</div>
              <div class="mini-actions">
                <button class="btn primary" onclick="alert('小游戏创建暂未实现')">创建游戏</button>
                <button class="btn" onclick="alert('小游戏历史暂未实现')">历史记录</button>
              </div>
            </div>
          </aside>
        </div>
      `;
      mount(shell(html,'courses'));

      // 渲染底部问题栏
      renderBottomDock(courseId);
    }

    function renderBottomDock(courseId){
      const prev = document.getElementById('bottom-dock');
      if(prev) prev.remove();
      const list = state.questions || [];
      if(list.length === 0){ return; }
      const dock = document.createElement('div');
      dock.id = 'bottom-dock';
      dock.className = 'bottom-dock';
      dock.innerHTML = list.map(q => `
        <div class="question-chip" onclick="openQuestionModal('${q.id}')">
          <strong>Q:</strong> <span>${escapeHTML(q.title)}</span>
          ${q.deadlineISO ? `<span class="deadline">· 截止 ${fmtDeadline(q.deadlineISO)}</span>` : ''}
        </div>
      `).join('');
      document.body.appendChild(dock);
    }

    async function copyJoinCode(){
      const cid = sessionStorage.getItem('currCourse');
      try{
        const { code } = await api(`/api/courses/${cid}/join-code`);
        await navigator.clipboard?.writeText(code);
        alert('加入码已复制：' + code);
      }catch(e){
        alert('复制失败：' + e.message);
      }
    }

    // ---- 弹窗：新建/编辑问答 ----
    let editingQuestionId = null;

    function openQuestionModal(id=null){
      editingQuestionId = id;
      const titleEl = document.getElementById('q-title');
      const descEl  = document.getElementById('q-desc');
      const ddlEl   = document.getElementById('q-deadline');
      const header  = document.getElementById('modal-title');

      if(id){
        const q = (state.questions || []).find(x=>x.id===id);
        header.textContent = '编辑问答';
        titleEl.value = q?.title || '';
        descEl.value  = q?.desc  || '';
        ddlEl.value   = q?.deadlineISO || '';
      }else{
        header.textContent = '新建问答';
        titleEl.value = '';
        descEl.value  = '';
        const d = new Date(Date.now() + 60*60*1000);
        ddlEl.value = toLocalDatetimeValue(d);
      }

      document.getElementById('modal-mask').style.display = 'flex';
    }

    function closeModal(ev){
      if(ev && ev.target && ev.target.id && ev.target.id !== 'modal-mask'){ return; }
      document.getElementById('modal-mask').style.display = 'none';
      editingQuestionId = null;
    }

    async function saveQuestion(){
      const cid = sessionStorage.getItem('currCourse');
      const title = document.getElementById('q-title').value.trim();
      const desc  = document.getElementById('q-desc').value.trim();
      const ddl   = document.getElementById('q-deadline').value;

      if(!title){ alert('请填写问题标题'); return; }

      try{
        if(editingQuestionId){
          const data = await api(`/api/courses/${cid}/questions/${editingQuestionId}`, {
            method:'PUT',
            body: JSON.stringify({ title, desc, deadlineISO: ddl || '' })
          });
          const idx = state.questions.findIndex(q=>q.id===editingQuestionId);
          if(idx>=0) state.questions[idx] = data.data;
        }else{
          const data = await api(`/api/courses/${cid}/questions`, {
            method:'POST',
            body: JSON.stringify({ title, desc, deadlineISO: ddl || '' })
          });
          state.questions.push(data.data);
        }
        closeModal();
        renderBottomDock(cid);
      }catch(e){
        alert('保存失败：' + e.message);
      }
    }

    /* —— 新增页面：AI 助手 —— */
    function renderClassAI(){
      const cid = sessionStorage.getItem('currCourse') || '';
      const c = state.courses.find(x=>x.id===cid) || { title: cid, id: cid };

      const html = `
        <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:12px'>
          <div>
            <small class='muted'>课堂 / ${c.id}</small>
            <h2 style='margin:4px 0 0 0'>AI 助手 · ${c.title}</h2>
          </div>
          <div style='display:flex;gap:8px'>
            <button class='btn' onclick="goto('#/teacher/classroom')">返回课堂</button>
          </div>
        </div>

        <div class='grid cols-2'>
          <div class='card'>
            <h3 style='margin-top:0'>🧭 自动备课</h3>
            <div class='muted'>根据教学目标与材料快速生成教学大纲、知识点与活动建议。</div>
            <div style='display:flex;gap:8px;margin-top:12px'>
              <input class='input' id='plan-topic' placeholder='输入本节课主题/材料链接'/>
              <button class='btn primary' onclick="alert('示例：已生成教案草稿（接口留空，可接后端）')">生成教案</button>
            </div>
          </div>

          <div class='card'>
            <h3 style='margin-top:0'>✏️ 自动产生题目</h3>
            <div class='muted'>从教材/课件抽取选择题、简答题，支持难度与题量设置。</div>
            <div style='display:flex;gap:8px;margin-top:12px;flex-wrap:wrap'>
              <input class='input' style='max-width:220px' id='q-count' placeholder='题量（如 10）'/>
              <select class='input' style='max-width:220px' id='q-level'>
                <option value='easy'>容易</option><option value='mid'>中等</option><option value='hard'>困难</option>
              </select>
              <button class='btn primary' onclick="alert('示例：已生成题目（接口留空，可接后端）')">生成题目</button>
            </div>
          </div>

          <div class='card'>
            <h3 style='margin-top:0'>🧾 总结课程信息</h3>
            <div class='muted'>自动汇总本节重点、常见错误与改进建议，可一键推送给学生。</div>
            <button class='btn primary' style='margin-top:8px' onclick="alert('示例：已生成课程总结（接口留空，可接后端）')">生成总结</button>
          </div>

          <div class='card'>
            <h3 style='margin-top:0'>🔁 一键发布</h3>
            <div class='muted'>将教案/题目/总结推送到本课程的讨论区或问答模块。</div>
            <button class='btn' style='margin-top:8px' onclick="alert('示例：已推送到讨论区（接口留空）')">推送到讨论区</button>
          </div>
        </div>
      `;
      mount(shell(html,'courses'));
    }

    /* —— 新增页面：讨论区 —— */
    function renderClassDiscuss(){
      const cid = sessionStorage.getItem('currCourse') || '';
      const c = state.courses.find(x=>x.id===cid) || { title: cid, id: cid };

      // 示例数据（可替换为 /api/courses/:cid/discussions）
      const discussions = [
        { id:'t1', title:'预习：阅读第2章并概括要点', replies:6, author:'助教A', updated:'今天 14:32' },
        { id:'t2', title:'课堂问题收集：多义词语境', replies:12, author:'Teacher', updated:'昨天 20:11' },
        { id:'t3', title:'作业1交流与答疑', replies:3, author:'助教B', updated:'10-08 09:10' }
      ];

      const cards = discussions.map(d=>`
        <div class='card' onclick="alert('进入话题 ${d.title}（可接详情页路由）')" style='cursor:pointer'>
          <b>${d.title}</b>
          <div class='muted'>回复 ${d.replies} · 发起 ${d.author} · 更新 ${d.updated}</div>
        </div>
      `).join('');

      const html = `
        <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:12px'>
          <div>
            <small class='muted'>课堂 / ${c.id}</small>
            <h2 style='margin:4px 0 0 0'>讨论区 · ${c.title}</h2>
          </div>
          <div style='display:flex;gap:8px'>
            <button class='btn' onclick="goto('#/teacher/classroom')">返回课堂</button>
            <button class='btn primary' onclick="alert('新建话题（可接后端）')">新建话题</button>
          </div>
        </div>
        <div class='grid cols-2'>${cards}</div>
      `;
      mount(shell(html,'courses'));
    }

    /* —— 新增页面：时间表 —— */
    function renderClassTimeline(){
      const cid = sessionStorage.getItem('currCourse') || '';
      const c = state.courses.find(x=>x.id===cid) || { title: cid, id: cid };

      // 示例：上课安排 + 问答/作业截止
      const sessions = [
        { time:'2025-10-12 10:00', tag:'上课', text:'第4讲：语义与语用' },
        { time:'2025-10-12 22:00', tag:'截止', text:'问答：课堂要点小结' },
      ];
      const qDeadlines = (state.questions||[])
        .filter(q=>q.deadlineISO).map(q=>({
          time: fmtDeadline(q.deadlineISO).replace(/(\d{2})-(\d{2})/,'$1月$2日'),
          tag:'截止', text:`问答：${q.title}`
        }));

      const items = [...sessions, ...qDeadlines]
         .sort((a,b)=>a.time.localeCompare(b.time))
         .map(i=>`
          <div class='card'>
            <div style='display:flex;justify-content:space-between;align-items:center'>
              <b>${i.text}</b>
              <span class='status ${i.tag==='截止'?'off':'on'}'>${i.tag}</span>
            </div>
            <div class='muted' style='margin-top:6px'>${i.time}</div>
          </div>
         `).join('');

      const html = `
        <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:12px'>
          <div>
            <small class='muted'>课堂 / ${c.id}</small>
            <h2 style='margin:4px 0 0 0'>时间表 · ${c.title}</h2>
          </div>
          <div style='display:flex;gap:8px'>
            <button class='btn' onclick="goto('#/teacher/classroom')">返回课堂</button>
            <button class='btn' onclick="alert('导出日程（可接 iCal/ICS）')">导出</button>
          </div>
        </div>
        <div class='grid cols-2'>${items || '<div class="card">暂无安排</div>'}</div>
      `;
      mount(shell(html,'courses'));
    }

    // 其他页面（保留）
    function renderAIStudio(){
      const html = `<h2>AI 辅助功能</h2><div class='grid cols-2'><div class='card'><b>从材料生成题目</b></div><div class='card'><b>相似答案聚类</b></div></div>`;
      mount(shell(html,'ai'));
    }
    function renderInsights(){
      const html = `<h2>信息展示</h2><div class='grid cols-3'><div class='card'><b>学生参与度</b></div><div class='card'><b>平均正确率</b></div><div class='card'><b>提交时长</b></div></div>`;
      mount(shell(html,'insights'));
    }

    // 路由
    function route(){
      removeFloatingUI();
      const h = location.hash || '#/login';
      (routes[h]||renderLogin)();
    }
    window.addEventListener('hashchange', route);
    route();

    // 小工具函数
    function toLocalDatetimeValue(date){
      const pad = n => String(n).padStart(2,'0');
      const y = date.getFullYear(), m = pad(date.getMonth()+1), d = pad(date.getDate());
      const hh = pad(date.getHours()), mm = pad(date.getMinutes());
      return `${y}-${m}-${d}T${hh}:${mm}`;
    }
    function fmtDeadline(iso){
      if(!iso) return '';
      const d = new Date(iso);
      if(isNaN(d)) return iso;
      const pad = n => String(n).padStart(2,'0');
      return `${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    function escapeHTML(str=''){
      return str.replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s]));
    }
  </script>
</body>
</html>
