<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PolyClass æ•™å¸ˆç«¯åŸå‹</title>
  <style>
    :root{
      --bg:#f5f9ff; --panel:#e6f0ff; --card:#ffffff; --border:#bcd2f0; --muted:#557aa3;
      --text:#0a1f33; --primary:#3a82f6; --primary-2:#60a5fa; --accent:#22d3ee;
      --ok:#16a34a; --warn:#f59e0b; --danger:#dc2626; --sidebar-width:260px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC",sans-serif}
    a{color:inherit;text-decoration:none}
    .btn{display:inline-flex;gap:8px;align-items:center;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--panel);cursor:pointer;transition:background .2s}
    .btn.primary{background:linear-gradient(90deg,var(--primary),var(--primary-2));border:0;color:#fff;font-weight:700}
    .btn:hover{background:var(--primary-2);color:#fff}
    .btn.ghost{background:transparent}
    .input,select,textarea{padding:12px 14px;border-radius:10px;border:1px solid var(--border);background:#fff;color:var(--text);width:100%}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 2px 4px rgba(0,0,0,.05)}
    .grid{display:grid;gap:16px}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
    .status{padding:4px 8px;border-radius:999px;font-size:12px}
    .on{background:#dcfce7;color:#166534}
    .off{background:#fee2e2;color:#991b1b}
    .topbar{position:fixed;left:0;right:0;top:0;height:56px;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:20}
    .brand{display:flex;gap:10px;align-items:center;font-weight:700;font-size:18px}
    .brand .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#60a5fa,#22d3ee)}
    .top-actions{display:flex;gap:10px;align-items:center}
    .avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#3b82f6,#06b6d4);cursor:pointer;border:2px solid #fff}
    .layout{display:flex;margin-top:56px;min-height:calc(100vh - 56px)}
    .sidebar{width:var(--sidebar-width);background:var(--panel);border-right:1px solid var(--border);padding:12px;display:flex;flex-direction:column;gap:8px}
    .nav a, .nav .nav-item{padding:10px 12px;border-radius:8px;display:flex;align-items:center;gap:10px;color:var(--muted);transition:background .2s;cursor:pointer}
    .nav a.active,.nav .nav-item.active,.nav a:hover,.nav .nav-item:hover{background:var(--primary-2);color:#fff}
    .content{flex:1;padding:18px;overflow:auto}
    .center{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .login-panel{max-width:560px;width:100%}
    .role{flex:1;padding:14px;border-radius:12px;border:1px solid var(--border);background:#fff;text-align:center;cursor:pointer}
    .role.active{outline:2px solid var(--primary)}
    .classroom-grid{display:grid;grid-template-columns: 1fr 320px;gap:16px;align-items:start}
    .activity-aside{position:sticky;top:86px;display:flex;flex-direction:column;gap:10px}
    .activity-aside .mini-card{padding:12px;border-radius:14px;border:1px solid var(--border);background:var(--card);box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .mini-title{font-weight:700;margin-bottom:4px}
    .mini-actions{display:flex;gap:8px;flex-wrap:wrap}
    .bottom-dock{position:fixed;left: calc(var(--sidebar-width) + 18px);right:18px;bottom:16px;z-index:14;display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap}
    .question-chip{background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px 12px;box-shadow:0 2px 6px rgba(0,0,0,.05);display:flex;gap:8px;align-items:center;cursor:pointer}
    .deadline{font-size:12px;color:var(--muted)}
    .modal-mask{position:fixed;inset:0;background:rgba(10,31,51,.35);display:none;align-items:center;justify-content:center;z-index:30}
    .modal{width:min(760px,92vw);background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 12px 30px rgba(0,0,0,.2)}
    .modal header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .modal footer{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}

    /* å¯¼èˆªæ ·å¼ */
    .nav-title{padding:12px 16px;font-weight:800;color:var(--text);cursor:pointer;display:flex;justify-content:space-between;align-items:center;border-radius:10px}
    .nav-title:hover{background:var(--panel)}
    .nav-group{margin-left:8px}
    .subnav{margin:6px 0 6px 16px;display:flex;flex-direction:column;gap:4px}
    .caret{font-size:12px;opacity:.8;transition:transform .18s ease}
    .caret.expanded{transform:rotate(90deg)}
    .course-parent{display:flex;justify-content:space-between;align-items:center}
    .course-name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

    /* è®¨è®ºé¡µæ ·å¼ */
    .segmented{display:inline-flex;border:1px solid var(--border);border-radius:10px;overflow:hidden}
    .segmented button{border:0;background:#fff;padding:8px 12px}
    .segmented button.active{background:var(--primary-2);color:#fff}
    .chat-box{display:flex;flex-direction:column;height:420px;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .chat-scroll{flex:1;overflow:auto;padding:12px;background:#f8fbff}
    .msg{margin:8px 0;display:flex;gap:8px}
    .msg.me{justify-content:flex-end}
    .msg .bubble{max-width:70%;padding:8px 10px;border-radius:12px;border:1px solid var(--border);background:#fff}
    .msg.me .bubble{background:#e8f0ff}
    .chat-input{display:flex;gap:8px;padding:8px;border-top:1px solid var(--border);background:#fff}

    /* æ—¶é—´è¡¨ */
    .filter-row{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    .calendar-day{font-weight:700;margin:8px 0 4px}
    .calendar-item{padding:10px;border:1px solid var(--border);border-radius:10px;margin:6px 0;background:#fff}

    /* å¤§å…ç®¡ç†è¡¨æ ¼ + é”™è¯¯æ¡ */
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px;border-bottom:1px solid var(--border);text-align:left}
    #error-bar{position:fixed;left:0;right:0;bottom:0;background:#dc2626;color:#fff;padding:8px 12px;display:none;z-index:9999}
    #error-bar .close{float:right;cursor:pointer;padding:0 6px}
    @media(max-width:980px){
      .grid.cols-3{grid-template-columns:repeat(2,1fr)}
      .sidebar{width:auto;flex-direction:row;border-right:0;border-bottom:1px solid var(--border)}
      .content{padding:12px}
      .classroom-grid{grid-template-columns:1fr}
      .activity-aside{position:static}
      .bottom-dock{left:12px;right:12px}
    }
  </style>
</head>
<body>
  <main id="app"></main>

  <!-- é€šç”¨å¼¹çª— -->
  <div id="modal-mask" class="modal-mask" onclick="closeModal(event)">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title" onclick="event.stopPropagation()">
      <header>
        <h3 id="modal-title" style="margin:0">æ–°å»º</h3>
        <button class="btn" aria-label="å…³é—­å¼¹çª—" onclick="closeModal()">âœ–</button>
      </header>
      <div id="modal-body" style="display:flex;flex-direction:column;gap:10px"></div>
      <footer id="modal-footer">
        <button class="btn" onclick="closeModal()">å–æ¶ˆ</button>
        <button class="btn primary" id="modal-save">ä¿å­˜</button>
      </footer>
    </div>
  </div>

  <!-- é”™è¯¯æç¤ºæ¡ -->
  <div id="error-bar"><span id="error-text"></span><span class="close" onclick="this.parentNode.style.display='none'">Ã—</span></div>

  <script>
  /************** é”™è¯¯æŠ¤æ  **************/
  (function setupErrorOverlay(){
    const show = (msg)=>{
      const bar = document.getElementById('error-bar');
      const txt = document.getElementById('error-text');
      if(bar && txt){ txt.textContent = String(msg || 'å‘ç”ŸæœªçŸ¥é”™è¯¯'); bar.style.display = 'block'; }
      console.error('[PolyClass Error]', msg);
    };
    window.addEventListener('error', (e)=> show(e?.error?.message || e?.message || e));
    window.addEventListener('unhandledrejection', (e)=> show(e?.reason?.message || e?.reason || e));
  })();

  /************** åŸºç¡€å·¥å…·/çŠ¶æ€ **************/
  const API_BASE = '';
  const TABS = [
    { key:'classroom', label:'è¿›å…¥è¯¾å ‚', hash:'#/teacher/classroom' },
    { key:'ai',        label:'AI åŠ©æ‰‹',  hash:'#/teacher/classroom/ai' },
    { key:'tools',     label:'å°ç»„ä»¶',    hash:'#/teacher/classroom/tools' },
    { key:'discuss',   label:'è®¨è®ºåŒº',    hash:'#/teacher/classroom/discuss' },
    { key:'timeline',  label:'æ—¶é—´è¡¨',    hash:'#/teacher/classroom/timeline' },
    { key:'insights',  label:'ä¿¡æ¯å±•ç¤º',  hash:'#/teacher/classroom/insights' },
  ];
  const state = {
    user: null,
    courses: [],
    students: [],
    questions: [],
    joinCode: '',
    showcase: [
      { id:'show-001', title:'ç°ä»£è¯—æ­Œèµæ', teacher:'ç‹è€å¸ˆ', students:120, public:true, desc:'é¢å‘æ‰€æœ‰äººå¼€æ”¾çš„ç¾å­¦è¯¾' },
      { id:'show-002', title:'Python å…¥é—¨', teacher:'æè€å¸ˆ', students:230, public:true, desc:'åŸºç¡€è¯­æ³•ä¸é¡¹ç›®å®è·µ' }
    ],
    sessions: {},
    discussions: {},
    ui: {
      myCoursesExpanded: true,
      groupExpanded: {},
      courseExpanded: {},
      timelineFilter: 'all', // all | class | assignment
    }
  };
  const routes = {
    '#/login': renderLogin,
    '#/teacher': renderTeacherShell,
    '#/teacher/profile': renderTeacherProfile,
    '#/teacher/courses': renderCourses,
    '#/teacher/classroom': renderClassroom,
    '#/teacher/classroom/ai': renderClassAI,
    '#/teacher/classroom/tools': renderCourseTools,
    '#/teacher/classroom/insights': renderCourseInsights,
    '#/teacher/classroom/discuss': renderClassDiscuss,
    '#/teacher/classroom/timeline': renderClassTimeline,
    '#/teacher/hall': renderHall,
    '#/teacher/meeting': renderMeeting,
    '#/teacher/ai': renderAIStudio,
    '#/teacher/insights': renderInsights
  };

  function mount(html){ const el = document.getElementById('app'); if(el) el.innerHTML = html; }
  function goto(hash){ location.hash = hash; }
  function qs(sel, root=document){ return root.querySelector(sel); }
  function qsa(sel, root=document){ return [...root.querySelectorAll(sel)]; }
  function safeJSON(res){ return res.json().catch(()=>({ message: res.statusText })); }
  async function api(path, options={}){
    const res = await fetch(API_BASE + path, {
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      ...options
    });
    if(!res.ok){
      const t = await safeJSON(res);
      throw new Error(t.message || `HTTP ${res.status}`);
    }
    return res.json();
  }
  function toLocalDatetimeValue(date){
    const pad = n => String(n).padStart(2,'0');
    const y = date.getFullYear(), m = pad(date.getMonth()+1), d = pad(date.getDate());
    const hh = pad(date.getHours()), mm = pad(date.getMinutes());
    return `${y}-${m}-${d}T${hh}:${mm}`;
  }
  function fmtDeadline(iso){
    try{
      if(!iso) return '';
      const d = new Date(iso);
      if(isNaN(d)) return iso;
      const pad = n => String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }catch{ return String(iso||''); }
  }
  function escapeHTML(str=''){
    return str.replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s]));
  }
  function formatCourseTitle(title){
    if(!title) return '';
    let t = title.replace(/è¯¾ç¨‹/g,'').trim();
    const m = t.match(/[A-Za-z0-9]+/g);
    if(m && m.length>0){ const w = m[0]; return w.length>14 ? w.slice(0,14) : w; }
    const first = t.split(/\s+/)[0] || t;
    return first.length>14 ? first.slice(0,14) : first;
  }
  function removeFloatingUI(){
    qs('#bottom-dock')?.remove();
    const mask = qs('#modal-mask');
    if(mask) mask.style.display = 'none';
  }

  /************** ä¾§æ  **************/
  function groupCourses(courses){
    const map = {};
    (courses||[]).forEach(c=>{
      const g = (c.group || c.category || 'å…¶ä»–').toString();
      if(!map[g]) map[g] = [];
      map[g].push(c);
    });
    return map;
  }
  function courseSubnavHTML(cid){
    return `
      <div class="subnav" data-course-sub="${cid}" style="display:${state.ui.courseExpanded[cid] ? 'flex' : 'none'}">
        ${TABS.map(t=>`
          <a class="nav-item course-sub-link" data-course-id="${cid}" data-href="${t.hash}" href="${t.hash}">â€¢ ${t.label}</a>
        `).join('')}
      </div>
    `;
  }
  function buildMyCourses(groups){
    const expanded = state.ui.myCoursesExpanded;
    const groupKeys = Object.keys(groups || {}).sort();
    // å¦‚æœæ²¡æœ‰ä»»ä½•è¯¾ç¨‹ï¼Œæ˜¾ç¤ºå ä½
    if(groupKeys.length === 0){
      return `
      <div class="nav-title" id="my-courses-title" role="button" tabindex="0" aria-expanded="${expanded}">
        <span>æˆ‘çš„è¯¾ç¨‹</span><span class="caret ${expanded?'expanded':''}">${expanded?'â–¼':'â–¶'}</span>
      </div>
      <div id="my-courses-box" style="display:${expanded?'block':'none'}">
        <div class="muted" style="padding:8px 12px">æš‚æ— è¯¾ç¨‹</div>
      </div>`;
    }
    // æ„å»ºæ¯ä¸ªåˆ†ç»„ï¼ˆä¾‹å¦‚ è®¡ç®—æœºã€è¯­è¨€å­¦ï¼‰ä½œä¸ºæˆ‘çš„è¯¾ç¨‹çš„å­åˆ†ç»„
    const groupsHTML = groupKeys.map(k=>{
      const gid = `group-${k}`;
      if(typeof state.ui.groupExpanded[gid] === 'undefined') state.ui.groupExpanded[gid] = true;
      const gExpanded = state.ui.groupExpanded[gid];
      const list = groups[k] || [];
      const coursesHTML = list.length ? list.map(c=>{
        if(state.ui.courseExpanded[c.id] === undefined) state.ui.courseExpanded[c.id] = false;
        const cExp = state.ui.courseExpanded[c.id];
        return `
          <div class="nav-item course-parent" data-course-toggle="${c.id}" role="button" tabindex="0" aria-expanded="${cExp}">
            <span class="course-name">ğŸ“š ${escapeHTML(formatCourseTitle(c.title||c.id))}</span>
            <span class="caret ${cExp?'expanded':''}">${cExp?'â–¼':'â–¶'}</span>
          </div>
          ${courseSubnavHTML(c.id)}
        `;
      }).join('') : `<div class="muted" style="padding:8px 12px">æš‚æ— è¯¾ç¨‹</div>`;

      return `
        <div class="nav-group">
          <div class="nav-item" data-group="${gid}" role="button" tabindex="0" aria-expanded="${gExpanded}">
            <span>ğŸ“ ${escapeHTML(k)}</span>
            <span class="caret ${gExpanded ? 'expanded' : ''}">${gExpanded ? 'â–¼' : 'â–¶'}</span>
          </div>
          <div class="subnav" data-sub="${gid}" style="display:${gExpanded ? 'flex' : 'none'}">
            ${coursesHTML}
          </div>
        </div>
      `;
    }).join('');

    return `
      <div class="nav-title" id="my-courses-title" role="button" tabindex="0" aria-expanded="${expanded}">
        <span>æˆ‘çš„è¯¾ç¨‹</span><span class="caret ${expanded?'expanded':''}">${expanded?'â–¼':'â–¶'}</span>
      </div>
      <div id="my-courses-box" style="display:${expanded?'block':'none'}">
        ${groupsHTML}
      </div>
    `;
  }
  function buildOtherGroups(groups){
    let html = '';
    Object.keys(groups).sort().forEach(k=>{
      if(k === 'å…¶ä»–') return;
      const gid = `group-${k}`;
      if(typeof state.ui.groupExpanded[gid] === 'undefined') state.ui.groupExpanded[gid] = true;
      const expanded = state.ui.groupExpanded[gid];
      html += `
        <div class="nav-group">
          <div class="nav-item" data-group="${gid}" role="button" tabindex="0" aria-expanded="${expanded}">
            <span>ğŸ“ ${escapeHTML(k)}</span>
            <span class="caret ${expanded ? 'expanded' : ''}">${expanded ? 'â–¼' : 'â–¶'}</span>
          </div>
          <div class="subnav" data-sub="${gid}" style="display:${expanded ? 'flex' : 'none'}">
            ${groups[k].map(c=>{
              if(state.ui.courseExpanded[c.id] === undefined) state.ui.courseExpanded[c.id] = false;
              const cExp = state.ui.courseExpanded[c.id];
              return `
                <div class="nav-item course-parent" data-course-toggle="${c.id}" role="button" tabindex="0" aria-expanded="${cExp}">
                  <span class="course-name">ğŸ“š ${escapeHTML(formatCourseTitle(c.title||c.id))}</span>
                  <span class="caret ${cExp?'expanded':''}">${cExp?'â–¼':'â–¶'}</span>
                </div>
                ${courseSubnavHTML(c.id)}
              `;
            }).join('')}
          </div>
        </div>
      `;
    });
    return html;
  }
  function buildPrefixLinks(){
    return `
      <a class="nav-item" href="#/teacher/hall">ğŸ›ï¸ è¯¾ç¨‹å¤§å…</a>
      <a class="nav-item" href="#/teacher/meeting">ğŸ¥ è§†é¢‘ä¼šè®®</a>
    `;
  }
  function renderSidebar(){
    const nav = qs('.sidebar .nav');
    if(!nav) return;
    const groups = groupCourses(state.courses || []);
    nav.innerHTML = `
      ${buildMyCourses(groups)}
      <div style="height:8px"></div>
      ${buildPrefixLinks()}
    `;
    const myTitle = qs('#my-courses-title', nav);
    if(myTitle){
      const toggle = () => { state.ui.myCoursesExpanded = !state.ui.myCoursesExpanded; renderSidebar(); highlightActiveNav(); };
      myTitle.addEventListener('click', toggle);
      myTitle.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggle(); }});
    }
    qsa('[data-course-toggle]', nav).forEach(el=>{
      const cid = el.getAttribute('data-course-toggle');
      const toggle = () => { state.ui.courseExpanded[cid] = !state.ui.courseExpanded[cid]; renderSidebar(); highlightActiveNav(); };
      el.addEventListener('click', toggle);
      el.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggle(); }});
    });
    qsa('.course-sub-link', nav).forEach(a=>{
      a.addEventListener('click', (ev)=>{
        // å…è®¸åŸç”Ÿå¯¼èˆªï¼Œä¸é˜»æ­¢é»˜è®¤
        const cid = a.getAttribute('data-course-id');
        const href = a.getAttribute('data-href');
        sessionStorage.setItem('currCourse', cid);
        // ç«‹å³é«˜äº®ï¼Œé˜²é—ªçƒ
        setTimeout(highlightActiveNav, 0);
      });
    });
    qsa('[data-group]', nav).forEach(el=>{
      const gid = el.getAttribute('data-group');
      const toggle = () => { state.ui.groupExpanded[gid] = !state.ui.groupExpanded[gid]; renderSidebar(); highlightActiveNav(); };
      el.addEventListener('click', toggle);
      el.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggle(); }});
    });
    highlightActiveNav();
  }
  function highlightActiveNav(){
    const nav = qs('.sidebar .nav'); if(!nav) return;
    qsa('.nav a, .nav .nav-item', nav).forEach(el=>el.classList.remove('active'));
    const h = location.hash || '';
    const currCid = sessionStorage.getItem('currCourse');
    const pref = nav.querySelector(`a[href="${h}"]`); if(pref) pref.classList.add('active');
    const sub = nav.querySelector(`.course-sub-link[data-course-id="${currCid}"][data-href="${h}"]`);
    if(sub){
      sub.classList.add('active');
      const parent = sub.closest('.nav-group, #my-courses-box')?.querySelector(`.course-parent[data-course-toggle="${currCid}"]`);
      parent?.classList.add('active'); return;
    }
    if(h === '#/teacher/classroom' && currCid){
      nav.querySelector(`.course-parent[data-course-toggle="${currCid}"]`)?.classList.add('active');
    }
  }

  /************** é¡µé¢æ¡†æ¶ **************/
  function shell(content){
    return `
    <header class='topbar'>
      <div class='brand' onclick="goto('#/teacher/courses')" style='cursor:pointer'>
        <div class='logo'></div>
        <div>PolyClass</div>
      </div>
      <div class='top-actions'>
        <span>${state.user?.email||''}</span>
        <div class='avatar' onclick="goto('#/teacher/profile')" title='æŸ¥çœ‹ä¸ªäººä¿¡æ¯'></div>
      </div>
    </header>
    <div class='layout'>
      <aside class='sidebar'><nav class='nav' aria-label="ä¾§è¾¹å¯¼èˆª"></nav></aside>
      <section class='content'>${content}</section>
    </div>`;
  }
  function updateSidebar(){ renderSidebar(); }

  /************** ç™»å½•ä¸åŸºç¡€é¡µ **************/
  function renderLogin(){
    mount(`
      <div class='center'>
        <div class='card login-panel'>
          <h2>ç™»å½• PolyClass</h2>
          <p class='muted'>è¯·é€‰æ‹©è§’è‰²ç™»å½•ï¼ˆå½“å‰ä»…å¼€æ”¾æ•™å¸ˆç«¯ï¼‰ã€‚</p>
          <div class='grid cols-3' style='margin:12px 0'>
            <div class='role' data-role='teacher' tabindex="0" role="button" aria-pressed="true">æ•™å¸ˆ</div>
            <div class='role' data-role='student' tabindex="0" role="button">å­¦ç”Ÿ</div>
            <div class='role' data-role='admin' tabindex="0" role="button">ç®¡ç†å‘˜</div>
          </div>
          <div style='display:flex;gap:10px;'>
            <input class='input' id='email' placeholder='é‚®ç®±' value='teacher@polyclass.edu' />
            <input class='input' id='pwd' placeholder='å¯†ç ' type='password' value='123456' />
          </div>
          <div style='margin-top:16px;display:flex;justify-content:space-between;align-items:center'>
            <span class='muted'>è½»è“ä¸»é¢˜ Â· Teamsé£æ ¼</span>
            <button class='btn primary' id='login-btn'>ç™»å½•</button>
          </div>
        </div>
      </div>
    `);
    let selectedRole = 'teacher';
    qsa('.role').forEach(el=>{
      const sel = ()=>{ qsa('.role').forEach(x=>x.classList.remove('active')); el.classList.add('active'); selectedRole = el.dataset.role; };
      el.addEventListener('click', sel);
      el.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); sel(); }});
    });
    qs(".role[data-role='teacher']")?.classList.add('active');
    qs('#login-btn')?.addEventListener('click', async ()=>{
      const email = qs('#email')?.value.trim();
      const password = qs('#pwd')?.value || '';
      if(!email || !password){ alert('è¯·è¾“å…¥é‚®ç®±ä¸å¯†ç '); return; }
      // æ¨¡æ‹Ÿç™»å½•
      state.user = {email, role:selectedRole, name:'Teacher'};
      goto('#/teacher');
    });
  }
  function renderTeacherShell(){ goto('#/teacher/courses'); }

  // æ•™å¸ˆä¸ªäººèµ„æ–™é¡µï¼ˆç®€å•å®ç°ï¼Œé¿å…æœªå®šä¹‰é”™è¯¯ï¼‰
  function renderTeacherProfile(){
    const user = state.user || { name:'æ•™å¸ˆ', email:'' };
    const html = `
      <h2>ä¸ªäººèµ„æ–™</h2>
      <div class='card' style='max-width:560px'>
        <div style='display:flex;align-items:center;gap:12px;margin-bottom:8px'>
          <div class='avatar' style='width:64px;height:64px;border-radius:12px'></div>
          <div>
            <div style='font-weight:700'>${escapeHTML(user.name||'æ•™å¸ˆ')}</div>
            <div class='muted'>${escapeHTML(user.email||'')}</div>
          </div>
        </div>
        <div style='margin-top:12px'>
          <div class='muted'>è§’è‰²</div>
          <div style='margin:6px 0 12px'>${escapeHTML(user.role||'teacher')}</div>
          <div style='display:flex;gap:8px'>
            <button class='btn' onclick="goto('#/teacher/courses')">è¿”å›è¯¾ç¨‹</button>
            <button class='btn primary' onclick='(function(){ state.user=null; sessionStorage.removeItem("currCourse"); goto("#/login"); })()'>ç™»å‡º</button>
          </div>
        </div>
      </div>
    `;
    mount(shell(html)); updateSidebar();
  }

  /************** Tabs & Header **************/
  function tabsHTML(activeKey){
    return `<div style='margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap'>
      ${TABS.map(t=>`<button class='btn ${t.key===activeKey?'primary':''}' data-href='${t.hash}'>${t.label}</button>`).join('')}
    </div>`;
  }
  function bindTabs(){ qsa('[data-href]').forEach(b=> b.addEventListener('click', ()=> goto(b.getAttribute('data-href')))); }
  function pageHeaderHTML(course, activeKey){
    const shared = !!course.public;
    return `
      <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:12px'>
        <div>
          <small class='muted'>è¯¾å ‚ / ${escapeHTML(course.id||'â€”')}</small>
          <h2 style='margin:4px 0 0 0'>${escapeHTML(course.title||course.id||'æœªå‘½åè¯¾ç¨‹')}</h2>
        </div>
        <div style='display:flex;gap:8px;align-items:center'>
          <label class='btn ghost' style='gap:6px'>
            <input id="share-toggle" type="checkbox" ${shared?'checked':''} style="accent-color:#3a82f6;transform:scale(1.1)"/>
            åˆ†äº«è‡³è¯¾ç¨‹å¤§å…
          </label>
          <button class='btn' onclick="goto('#/teacher/courses')">è¿”å›è¯¾ç¨‹åˆ—è¡¨</button>
          <button class='btn' onclick="copyJoinCode()">å¤åˆ¶åŠ å…¥ç </button>
        </div>
      </div>
      ${tabsHTML(activeKey)}
    `;
  }

  /************** è¯¾ç¨‹åˆ—è¡¨ **************/
  async function renderCourses(){
    // åˆå§‹åŒ–è¯¾ç¨‹ï¼ˆä»…é¦–æ¬¡ï¼‰
    if(state.courses.length===0){
      state.courses = [
        {id:'CS101', title:'è®¡ç®—æœºåŸºç¡€', students:45, updated:'10-09', public:false, group:'è®¡ç®—æœº'},
        {id:'LING201', title:'è¯­ä¹‰å­¦å¯¼è®º', students:60, updated:'10-08', public:true,  group:'è¯­è¨€å­¦'},
        {id:'AI500', title:'AI åº”ç”¨å®è·µ', students:38, updated:'10-07', public:false, group:'è®¡ç®—æœº'}
      ];
      state.sessions['CS101'] = [{ time:'2025-10-12 10:00', tag:'ä¸Šè¯¾', text:'ç¬¬4è®²ï¼šC åŸºç¡€' }];
      state.sessions['LING201'] = [{ time:'2025-10-13 09:00', tag:'ä¸Šè¯¾', text:'ç¬¬3è®²ï¼šè¯­ä¹‰è§’è‰²' }];
      state.sessions['AI500'] = [{ time:'2025-10-12 14:00', tag:'ä¸Šè¯¾', text:'ç¬¬2è®²ï¼šæ•°æ®æ¸…æ´—' }];
    }
    const cards = (state.courses||[]).map(c=>`
      <div class='card'>
        <b>${escapeHTML(c.title||c.id||'æœªå‘½åè¯¾ç¨‹')}</b>
        <div class='muted'>ç¼–å·ï¼š${escapeHTML(c.id||'-')} Â· å­¦ç”Ÿ ${c.students ?? 0} Â· æ›´æ–° ${escapeHTML(c.updated||'-')}</div>
        <div style='margin-top:8px;display:flex;gap:8px;align-items:center'>
          <button class='btn primary' onclick="openClassroom('${c.id}')">è¿›å…¥è¯¾å ‚</button>
          <span class='status ${c.public? 'on':'off'}'>${c.public? 'å…¬å¼€':'ç§å¯†'}</span>
        </div>
      </div>`).join('');
    const html = `
      <h2>è¯¾ç¨‹</h2>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
        <div class="muted">ç®¡ç†/æµè§ˆä½ çš„è¯¾ç¨‹</div>
        <div style="display:flex; gap:8px">
          <button class="btn">â• åŠ å…¥è¯¾ç¨‹</button>
          <button class="btn primary">â• æ–°å»ºè¯¾ç¨‹</button>
        </div>
      </div>
      <div class='grid cols-2'>${cards || '<div class="card">æš‚æ— è¯¾ç¨‹</div>'}</div>`;
    mount(shell(html));
    updateSidebar();
  }
  function openClassroom(cid){
    if(!cid) return;
    sessionStorage.setItem('currCourse', cid);
    const h = location.hash || '';
    if(h.startsWith('#/teacher/classroom')) goto(h); else goto('#/teacher/classroom');
  }

  /************** è¯¾å ‚çˆ¶é¡µ **************/
  async function renderClassroom(){
    let cid = sessionStorage.getItem('currCourse');
    if(!cid && state.courses.length){ cid = state.courses[0]?.id; sessionStorage.setItem('currCourse', cid); }
    const courseId = cid || '';
    const c = (state.courses.find(x=>x.id===courseId) || { id: courseId, title: courseId });

    // ç¤ºä¾‹å­¦ç”Ÿ/é—®é¢˜
    if(!state.students.length){
      state.students = [
        {id:'2025001', name:'Alice', status:'online', score:92, submissions:3},
        {id:'2025002', name:'Bob',   status:'offline', score:78, submissions:2},
      ];
    }
    if(!state.questions.length){
      state.questions = [
        {id:'q1', title:'è¯¾å ‚è¦ç‚¹å°ç»“', deadlineISO:'2025-10-12T22:00'},
        {id:'q2', title:'ç¬¬3è®²éšå ‚ç»ƒä¹ ', deadlineISO:'2025-10-14T18:00'}
      ];
    }

    const studentRows = (state.students||[]).map(s=>`
      <tr>
        <td>${escapeHTML(s.id||'-')}</td>
        <td>${escapeHTML(s.name||'-')}</td>
        <td><span class='status ${s.status==='online'?'on':'off'}'>${s.status==='online'?'åœ¨çº¿':'ç¦»çº¿'}</span></td>
        <td>${s.score ?? '-'}</td>
        <td>${s.submissions ?? 0}</td>
        <td><button class='btn'>è¯¦æƒ…</button></td>
      </tr>`).join('');

    const inner = `
      ${pageHeaderHTML(c,'classroom')}
      <div class="classroom-grid">
        <div class='card'>
          <h3 style='margin-top:0'>å­¦ç”Ÿæ¦‚è§ˆ</h3>
          <table>
            <thead><tr><th>å­¦å·</th><th>å§“å</th><th>çŠ¶æ€</th><th>å¹³å‡åˆ†</th><th>æäº¤æ¬¡æ•°</th><th>æ“ä½œ</th></tr></thead>
            <tbody>${studentRows || '<tr><td colspan="6" class="muted">æš‚æ— å­¦ç”Ÿ</td></tr>'}</tbody>
          </table>
        </div>
        <aside class="activity-aside">
          <div class="mini-card">
            <div class="mini-title">ğŸ—³ï¸ æŠ•ç¥¨</div>
            <div class="muted" style="margin-bottom:8px">å•é€‰ / å¤šé€‰</div>
            <div class="mini-actions">
              <button class="btn primary" onclick="alert('æŠ•ç¥¨åˆ›å»ºæš‚æœªå®ç°')">æ–°å»ºæŠ•ç¥¨</button>
              <button class="btn" onclick="alert('æŠ•ç¥¨å†å²æš‚æœªå®ç°')">å†å²è®°å½•</button>
            </div>
          </div>
          <div class="mini-card">
            <div class="mini-title">ğŸ“ é—®ç­”</div>
            <div class="muted" style="margin-bottom:8px">ç®€ç­” / è¯äº‘</div>
            <div class="mini-actions">
              <button class="btn primary" onclick="openQuestionModal()">æ–°å»ºé—®ç­”</button>
              <button class="btn" onclick="alert('é—®ç­”å†å²æš‚æœªå®ç°')">å†å²è®°å½•</button>
            </div>
          </div>
          <div class="mini-card">
            <div class="mini-title">ğŸ® å°æ¸¸æˆ</div>
            <div class="muted" style="margin-bottom:8px">æŠ¢ç­” / æ’è¡Œæ¦œ</div>
            <div class="mini-actions">
              <button class="btn primary" onclick="alert('å°æ¸¸æˆåˆ›å»ºæš‚æœªå®ç°')">åˆ›å»ºæ¸¸æˆ</button>
              <button class="btn" onclick="alert('å°æ¸¸æˆå†å²æš‚æœªå®ç°')">å†å²è®°å½•</button>
            </div>
          </div>
        </aside>
      </div>`;
    mount(shell(inner));
    updateSidebar();
    bindTabs();
    renderBottomDock(courseId);

    // åˆ†äº«å¼€å…³
    qs('#share-toggle')?.addEventListener('change', (e)=>{
      const checked = e.target.checked;
      const idx = state.courses.findIndex(x=>x.id===courseId);
      if(idx>=0){ state.courses[idx].public = checked; }
      updateSidebar();
    });
  }

  /************** å­é¡µï¼šAI / å·¥å…· / ä¿¡æ¯ **************/
  function renderSubpage(activeKey, bodyHTMLBuilder){
    const cid = sessionStorage.getItem('currCourse') || '';
    const c = state.courses.find(x=>x.id===cid) || { title: cid, id: cid };
    const inner = `${pageHeaderHTML(c,activeKey)}${bodyHTMLBuilder(c)}`;
    mount(shell(inner));
    updateSidebar();
    bindTabs();
  }
  function renderClassAI(){ renderSubpage('ai', ()=>`
    <div class='grid cols-2'>
      <div class='card'>
        <h3 style='margin-top:0'>ğŸ§­ è‡ªåŠ¨å¤‡è¯¾</h3>
        <div class='muted'>æ ¹æ®æ•™å­¦ç›®æ ‡ä¸ææ–™å¿«é€Ÿç”Ÿæˆæ•™å­¦å¤§çº²ã€çŸ¥è¯†ç‚¹ä¸æ´»åŠ¨å»ºè®®ã€‚</div>
        <div style='display:flex;gap:8px;margin-top:12px'>
          <input class='input' id='plan-topic' placeholder='è¾“å…¥æœ¬èŠ‚è¯¾ä¸»é¢˜/ææ–™é“¾æ¥'/>
          <button class='btn primary' onclick="alert('ç¤ºä¾‹ï¼šå·²ç”Ÿæˆæ•™æ¡ˆè‰ç¨¿ï¼ˆæ¥å£ç•™ç©ºï¼Œå¯æ¥åç«¯ï¼‰')">ç”Ÿæˆæ•™æ¡ˆ</button>
        </div>
      </div>
      <div class='card'>
        <h3 style='margin-top:0'>âœï¸ è‡ªåŠ¨äº§ç”Ÿé¢˜ç›®</h3>
        <div class='muted'>ä»æ•™æ/è¯¾ä»¶æŠ½å–é€‰æ‹©é¢˜ã€ç®€ç­”é¢˜ï¼Œæ”¯æŒéš¾åº¦ä¸é¢˜é‡è®¾ç½®ã€‚</div>
        <div style='display:flex;gap:8px;margin-top:12px;flex-wrap:wrap'>
          <input class='input' style='max-width:220px' id='q-count' placeholder='é¢˜é‡ï¼ˆå¦‚ 10ï¼‰'/>
          <select class='input' style='max-width:220px' id='q-level'>
            <option value='easy'>å®¹æ˜“</option><option value='mid'>ä¸­ç­‰</option><option value='hard'>å›°éš¾</option>
          </select>
          <button class='btn primary' onclick="alert('ç¤ºä¾‹ï¼šå·²ç”Ÿæˆé¢˜ç›®ï¼ˆæ¥å£ç•™ç©ºï¼Œå¯æ¥åç«¯ï¼‰')">ç”Ÿæˆé¢˜ç›®</button>
        </div>
      </div>
      <div class='card'><h3 style='margin-top:0'>ğŸ§¾ æ€»ç»“è¯¾ç¨‹ä¿¡æ¯</h3><div class='muted'>è‡ªåŠ¨æ±‡æ€»æœ¬èŠ‚é‡ç‚¹ã€å¸¸è§é”™è¯¯ä¸æ”¹è¿›å»ºè®®ã€‚</div><button class='btn primary' style='margin-top:8px' onclick="alert('ç¤ºä¾‹ï¼šå·²ç”Ÿæˆè¯¾ç¨‹æ€»ç»“')">ç”Ÿæˆæ€»ç»“</button></div>
      <div class='card'><h3 style='margin-top:0'>ğŸ” ä¸€é”®å‘å¸ƒ</h3><div class='muted'>å°†æ•™æ¡ˆ/é¢˜ç›®/æ€»ç»“æ¨é€åˆ°è®¨è®ºåŒºæˆ–é—®ç­”æ¨¡å—ã€‚</div><button class='btn' style='margin-top:8px' onclick="alert('ç¤ºä¾‹ï¼šå·²æ¨é€åˆ°è®¨è®ºåŒº')">æ¨é€åˆ°è®¨è®ºåŒº</button></div>
    </div>`); }

  function renderCourseTools(){ renderSubpage('tools', ()=>`
    <div class='grid cols-2'>
      <div class='card'>
        <h3 style='margin-top:0'>ğŸ“¢ å‘å¸ƒæŠ•ç¥¨</h3>
        <div class='muted'>å¿«é€Ÿåˆ›å»ºå•/å¤šé€‰æŠ•ç¥¨å¹¶æ¨é€åˆ°å®æ—¶è®¨è®ºåŒºã€‚</div>
        <button class='btn primary' onclick="alert('å ä½ï¼šå‘å¸ƒæŠ•ç¥¨')">å‘å¸ƒæŠ•ç¥¨</button>
      </div>
      <div class='card'>
        <h3 style='margin-top:0'>ğŸ“˜ å‘å¸ƒä½œä¸š</h3>
        <div class='muted'>å¸ƒç½®ä½œä¸šå¹¶è®¾å®šæˆªæ­¢æ—¶é—´ï¼Œè‡ªåŠ¨è¿›å…¥æ—¶é—´è¡¨-ä½œä¸šè§†å›¾ã€‚</div>
        <button class='btn primary' onclick="quickCreateAssignment()">å‘å¸ƒä½œä¸š</button>
      </div>
      <div class='card'>
        <h3 style='margin-top:0'>ğŸ§ª å‘å¸ƒ Quiz</h3>
        <div class='muted'>åˆ›å»ºå°æµ‹éªŒï¼Œæ”¯æŒå®¢è§‚é¢˜è‡ªåŠ¨åˆ¤åˆ†ã€‚</div>
        <button class='btn primary' onclick="alert('å ä½ï¼šå‘å¸ƒ Quiz')">å‘å¸ƒ Quiz</button>
      </div>
      <div class='card'>
        <h3 style='margin-top:0'>â“ å‘å¸ƒé—®ç­”</h3>
        <div class='muted'>å¿«é€Ÿåˆ›å»ºé—®ç­”è¯é¢˜ï¼Œè‡ªåŠ¨å‡ºç°åœ¨åº•éƒ¨é—®ç­”æ ã€‚</div>
        <button class='btn primary' onclick="openQuestionModal()">å‘å¸ƒé—®ç­”</button>
      </div>
      <div class='card'>
        <h3 style='margin-top:0'>ğŸ§© å¤šé€‰äº’åŠ¨</h3>
        <div class='muted'>å‘èµ·å¤šé€‰äº’åŠ¨é¢˜ï¼Œå®æ—¶ç»Ÿè®¡å¯è§†åŒ–ã€‚</div>
        <button class='btn primary' onclick="alert('å ä½ï¼šå¤šé€‰äº’åŠ¨')">å‘èµ·äº’åŠ¨</button>
      </div>
      <div class='card'>
        <h3 style='margin-top:0'>ğŸ® å°æ¸¸æˆäº’åŠ¨</h3>
        <div class='muted'>æŠ¢ç­” / æ’è¡Œæ¦œç­‰è¯¾å ‚å°æ¸¸æˆã€‚</div>
        <button class='btn primary' onclick="alert('å ä½ï¼šå°æ¸¸æˆäº’åŠ¨')">å¼€å§‹æ¸¸æˆ</button>
      </div>
    </div>`); }
  function quickCreateAssignment(){
    const cid = sessionStorage.getItem('currCourse') || '';
    const ttl = 'ä½œä¸šï¼šé˜…è¯»ç¬¬4ç« å¹¶å®Œæˆä¹ é¢˜';
    const ddl = new Date(Date.now()+2*24*3600*1000);
    state.questions.push({id:'hw-'+Date.now(), title:ttl, deadlineISO: toLocalDatetimeValue(ddl)});
    alert('å·²åˆ›å»ºä½œä¸šï¼Œå¹¶åŠ å…¥æ—¶é—´è¡¨ï¼ˆä½œä¸šï¼‰');
    goto('#/teacher/classroom/timeline');
    state.ui.timelineFilter = 'assignment';
  }
  function renderCourseInsights(){ renderSubpage('insights', ()=>`
    <div class='grid cols-3'>
      <div class='card'><b>æœ¬å‘¨å‚ä¸åº¦</b></div>
      <div class='card'><b>å¹³å‡æ­£ç¡®ç‡</b></div>
      <div class='card'><b>æäº¤åˆ†å¸ƒ</b></div>
    </div>`); }

  /************** è®¨è®ºåŒºï¼šå®æ—¶+å¸–å­ **************/
  function ensureDiscussion(cid){
    if(!state.discussions[cid]){
      state.discussions[cid] = {
        chatMessages:[
          {id:1, role:'teacher', name:'Teacher', text:'å¤§å®¶å¥½ï¼Œå¼€å§‹ä¸Šè¯¾å•¦ï½', time:fmtDeadline(new Date().toISOString())},
          {id:2, role:'student', name:'Alice', text:'æ”¶åˆ°è€å¸ˆ', time:fmtDeadline(new Date().toISOString())}
        ],
        posts:{ teacher:[], student:[] }
      };
    }
    return state.discussions[cid];
  }
  function renderClassDiscuss(){
    const cid = sessionStorage.getItem('currCourse') || '';
    const c = state.courses.find(x=>x.id===cid) || { title: cid, id: cid };
    const d = ensureDiscussion(cid);

    // ä¸ºé¿å…åœ¨æ¨¡æ¿ä¸­åµŒå¥—åå¼•å·å¼•èµ·è§£æé—®é¢˜ï¼Œå…ˆæ„å»ºæ¶ˆæ¯åˆ—è¡¨å­—ç¬¦ä¸²
    const messagesHTML = (d.chatMessages || []).map(m => {
      return '<div class="msg ' + (m.role==='teacher' ? 'me' : '') + '">' +
        '<div class="bubble"><b>' + escapeHTML(m.name) + 'ï¼š</b>' + escapeHTML(m.text) + '<div class="muted" style="font-size:12px">' + escapeHTML(m.time) + '</div></div>' +
      '</div>';
    }).join('');

    const chatHTML = `
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <b>å®æ—¶è®¨è®º</b>
          <div class="muted">ç±»ä¼¼å¾®ä¿¡ç¾¤ï¼šæ‰€æœ‰äººå¯è§</div>
        </div>
        <div class="chat-box">
          <div id="chat-scroll" class="chat-scroll">
            ${messagesHTML}
          </div>
          <div class="chat-input">
            <input id="chat-input" class="input" placeholder="è¾“å…¥æ¶ˆæ¯å¹¶å›è½¦å‘é€"/>
            <button class="btn primary" id="chat-send">å‘é€</button>
          </div>
        </div>
      </div>
    `;
    const postCard = (p)=>`
      <div class="card">
        <b>${escapeHTML(p.title)}</b>
        <div class="muted" style="margin-top:6px">${escapeHTML(p.content||'')}</div>
        <div class="muted" style="margin-top:6px;font-size:12px">å‘å¸ƒè€…ï¼š${escapeHTML(p.author||'â€”')} Â· ${escapeHTML(p.time||'')}</div>
      </div>
    `;
    const postsHTML = `
      <div class="grid cols-2">
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <b>å¸–å­è®¨è®ºï¼ˆè€å¸ˆå‘å¸ƒï¼‰</b>
            <button class="btn" onclick="openPostEditor('teacher')">+ æ–°å»º</button>
          </div>
          ${d.posts.teacher.map(postCard).join('') || '<div class="card">æš‚æ— è€å¸ˆå¸–å­</div>'}
        </div>
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <b>å¸–å­è®¨è®ºï¼ˆå­¦ç”Ÿå‘å¸ƒï¼‰</b>
            <button class="btn" onclick="openPostEditor('student')">+ æ–°å»º</button>
          </div>
          ${d.posts.student.map(postCard).join('') || '<div class="card">æš‚æ— å­¦ç”Ÿå¸–å­</div>'}
        </div>
      </div>
    `;
    const inner = `
      ${pageHeaderHTML(c,'discuss')}
      <div class="segmented" style="margin-bottom:12px">
        <button class="seg-btn active" data-panel="chat">å®æ—¶è®¨è®º</button>
        <button class="seg-btn" data-panel="posts">å¸–å­è®¨è®º</button>
      </div>
      <div id="panel-chat">${chatHTML}</div>
      <div id="panel-posts" style="display:none">${postsHTML}</div>
    `;
    mount(shell(inner));
    updateSidebar();
    bindTabs();

    // åˆ‡æ¢é¢æ¿
    qsa('.seg-btn').forEach(b=>{
      b.addEventListener('click', ()=>{
        qsa('.seg-btn').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        const p = b.getAttribute('data-panel');
        qs('#panel-chat').style.display = (p==='chat')?'block':'none';
        qs('#panel-posts').style.display = (p==='posts')?'block':'none';
      });
    });
    // å‘é€èŠå¤©
    const send = ()=>{
      const ipt = qs('#chat-input'); if(!ipt) return;
      const txt = (ipt.value||'').trim(); if(!txt) return;
      const msg = {id:Date.now(), role:'teacher', name:'Teacher', text:txt, time:fmtDeadline(new Date().toISOString())};
      d.chatMessages.push(msg);
      renderClassDiscuss();
      setTimeout(()=>{ const sc=qs('#chat-scroll'); if(sc){ sc.scrollTop=sc.scrollHeight; } },0);
    };
    qs('#chat-send')?.addEventListener('click', send);
    qs('#chat-input')?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ send(); } });
  }
  function openPostEditor(role){
    const cid = sessionStorage.getItem('currCourse') || '';
    const d = ensureDiscussion(cid);
    const body = qs('#modal-body'), title = qs('#modal-title'), save = qs('#modal-save');
    title.textContent = `æ–°å»ºå¸–å­ï¼ˆ${role==='teacher'?'è€å¸ˆ':'å­¦ç”Ÿ'}å‘å¸ƒï¼‰`;
    body.innerHTML = `
      <label><div class="muted">æ ‡é¢˜</div><input id="post-title" class="input" placeholder="è¯·è¾“å…¥æ ‡é¢˜ï¼ˆå¿…å¡«ï¼‰"/></label>
      <label><div class="muted">å†…å®¹</div><textarea id="post-content" class="input" rows="4" placeholder="è¯·è¾“å…¥å†…å®¹"></textarea></label>
    `;
    save.onclick = ()=>{
      const t = qs('#post-title')?.value.trim(); const c = qs('#post-content')?.value.trim();
      if(!t){ alert('è¯·å¡«å†™æ ‡é¢˜'); return; }
      const post = { title:t, content:c, time:fmtDeadline(new Date().toISOString()), author: role==='teacher'?'Teacher':'Student' };
      d.posts[role].unshift(post);
      closeModal(); renderClassDiscuss();
    };
    qs('#modal-mask').style.display='flex';
  }

  /************** æ—¶é—´è¡¨ï¼šè¿‡æ»¤ä¸æ—¥å†å¼ **************/
  function renderClassTimeline(){
    const cid = sessionStorage.getItem('currCourse') || '';
    const c = state.courses.find(x=>x.id===cid) || { title: cid, id: cid };
    const sessions = state.sessions[cid] || [];
    const assignments = (state.questions||[])
      .filter(q=>q.deadlineISO).map(q=>({ time: (q.deadlineISO||'').replace('T',' '), tag:'ä½œä¸š', text:`${q.title}` }));

    const filter = state.ui.timelineFilter || 'all';
    const items = [
      ...(filter!=='assignment' ? sessions : []),
      ...(filter!=='class' ? assignments : [])
    ].sort((a,b)=> (a.time||'').localeCompare(b.time||''));

    const groups = {};
    items.forEach(i=>{
      const d = (i.time||'').slice(0,10) || 'æœªåˆ†ç»„';
      if(!groups[d]) groups[d]=[];
      groups[d].push(i);
    });

    const calendarHTML = Object.keys(groups).sort().map(day=>`
      <div class="calendar-day">${escapeHTML(day)}</div>
      ${groups[day].map(i=>`
        <div class="calendar-item">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <b>${escapeHTML(i.text||'')}</b>
            <span class="status ${i.tag==='ä½œä¸š'?'off':'on'}">${escapeHTML(i.tag||'')}</span>
          </div>
          <div class="muted" style="margin-top:6px">${escapeHTML(i.time||'')}</div>
        </div>
      `).join('')}
    `).join('') || '<div class="card">æš‚æ— æ—¥ç¨‹</div>';

    const filterBar = `
      <div class="filter-row">
        <span class='muted'>ç­›é€‰ï¼š</span>
        <button class="btn ${filter==='all'?'primary':''}" data-filter="all">å…¨éƒ¨</button>
        <button class="btn ${filter==='class'?'primary':''}" data-filter="class">åªçœ‹è¯¾ç¨‹æ—¶é—´</button>
        <button class="btn ${filter==='assignment'?'primary':''}" data-filter="assignment">åªçœ‹ä½œä¸š</button>
      </div>
    `;
    const inner = `${pageHeaderHTML(c,'timeline')}${filterBar}<div>${calendarHTML}</div>`;
    mount(shell(inner));
    updateSidebar();
    bindTabs();
    qsa('[data-filter]').forEach(b=>{
      b.addEventListener('click', ()=>{
        state.ui.timelineFilter = b.getAttribute('data-filter');
        renderClassTimeline();
      });
    });
  }

  /************** åº•éƒ¨é—®ç­” Chips **************/
  function renderBottomDock(courseId){
    qs('#bottom-dock')?.remove();
    const list = state.questions || [];
    if(list.length === 0) return;
    const dock = document.createElement('div');
    dock.id = 'bottom-dock';
    dock.className = 'bottom-dock';
    dock.innerHTML = list.map(q => `
      <div class="question-chip" onclick="openQuestionModal('${q.id}')">
        <strong>Q:</strong> <span>${escapeHTML(q.title||'â€”')}</span>
        ${q.deadlineISO ? `<span class="deadline">Â· æˆªæ­¢ ${fmtDeadline(q.deadlineISO)}</span>` : ''}
      </div>`).join('');
    document.body.appendChild(dock);
  }

  /************** é—®ç­”å¼¹çª—ï¼ˆå¤ç”¨é€šç”¨å¼¹çª—ï¼‰ **************/
  let editingQuestionId = null;
  function openQuestionModal(id=null){
    editingQuestionId = id;
    const body = qs('#modal-body'), title = qs('#modal-title'), save = qs('#modal-save');
    title.textContent = id?'ç¼–è¾‘é—®ç­”':'æ–°å»ºé—®ç­”';
    const q = (state.questions || []).find(x=>x.id===id) || {};
    body.innerHTML = `
      <label><div class="muted">é—®é¢˜æ ‡é¢˜</div><input id="q-title" class="input" placeholder="è¯·è¾“å…¥é—®é¢˜æ ‡é¢˜ï¼ˆå¿…å¡«ï¼‰" value="${escapeHTML(q.title||'')}" /></label>
      <label><div class="muted">è¯¦ç»†è¯´æ˜</div><textarea id="q-desc" class="input" rows="4" placeholder="å¯è¡¥å……èƒŒæ™¯ã€ç­”é¢˜è¦æ±‚ç­‰">${escapeHTML(q.desc||'')}</textarea></label>
      <label><div class="muted">æˆªæ­¢æ—¶é—´</div><input id="q-deadline" class="input" type="datetime-local" value="${q.deadlineISO||toLocalDatetimeValue(new Date(Date.now()+3600000))}"/></label>
    `;
    save.onclick = saveQuestion;
    qs('#modal-mask').style.display='flex';
  }
  function closeModal(ev){
    if(ev && ev.target && ev.target.id && ev.target.id !== 'modal-mask') return;
    const mask = qs('#modal-mask'); if(mask) mask.style.display = 'none';
    editingQuestionId = null;
  }
  async function saveQuestion(){
    const cid = sessionStorage.getItem('currCourse');
    const title = qs('#q-title')?.value.trim();
    const desc  = qs('#q-desc')?.value.trim();
    const ddl   = qs('#q-deadline')?.value;
    if(!title){ alert('è¯·å¡«å†™é—®é¢˜æ ‡é¢˜'); return; }
    if(editingQuestionId){
      const idx = state.questions.findIndex(q=>q.id===editingQuestionId);
      const updated = { id:editingQuestionId, title, desc, deadlineISO: ddl||'' };
      if(idx>=0) state.questions[idx] = updated;
    }else{
      const created = { id:'q'+Date.now(), title, desc, deadlineISO: ddl||'' };
      state.questions.push(created);
    }
    closeModal(); renderBottomDock(cid);
  }

  /************** è¯¾ç¨‹å¤§å…ï¼ˆå±•ç¤ºè¯¾å¯ç¼–è¾‘ï¼‰ **************/
  function renderHall(){
    const livePublics = (state.courses||[]).filter(c=>c.public);
    const showcase = state.showcase || [];
    const card = c=>`
      <div class='card'>
        <div style='display:flex;gap:10px;align-items:center'>
          <img src='https://picsum.photos/seed/${encodeURIComponent(c.id)}/120/80' style='width:120px;height:80px;border-radius:8px;object-fit:cover' alt='thumb'/>
          <div style='flex:1'>
            <b>${escapeHTML(c.title||c.id||'æœªå‘½åè¯¾ç¨‹')}</b>
            <div class='muted' style='margin-top:6px'>${escapeHTML(c.desc || 'æš‚æ— æè¿°')}</div>
            <div style='margin-top:8px;display:flex;gap:8px;align-items:center'>
              <button class='btn primary' onclick="openClassroom('${c.id}')">æŸ¥çœ‹è¯¾ç¨‹</button>
              <span class='muted'>${escapeHTML(c.teacher||'æ•™å¸ˆ')} Â· ${c.students||0} å­¦ç”Ÿ</span>
              <span style='margin-left:auto' class='status ${c.public? 'on':'off'}'>${c.public? 'å…¬å¼€':'å±•ç¤º'}</span>
            </div>
          </div>
        </div>
      </div>`;
    const manageTable = `
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <b>å±•ç¤ºè¯¾ç¨‹ï¼ˆå¯ç¼–è¾‘ï¼Œä»…ä½œå±•ç¤ºï¼‰</b>
          <button class="btn primary" onclick="openShowcaseEditor()">+ æ–°å¢å±•ç¤ºè¯¾ç¨‹</button>
        </div>
        <table class="table" style="margin-top:10px">
          <thead><tr><th>ID</th><th>æ ‡é¢˜</th><th>æ•™å¸ˆ</th><th>å­¦ç”Ÿ</th><th>æ“ä½œ</th></tr></thead>
          <tbody>
            ${showcase.map((s,i)=>`
              <tr>
                <td>${escapeHTML(s.id)}</td>
                <td>${escapeHTML(s.title)}</td>
                <td>${escapeHTML(s.teacher||'')}</td>
                <td>${s.students||0}</td>
                <td>
                  <button class="btn" onclick="openShowcaseEditor(${i})">ç¼–è¾‘</button>
                  <button class="btn" onclick="deleteShowcase(${i})">åˆ é™¤</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
    const html = `
      <h2>è¯¾ç¨‹å¤§å…</h2>
      <div class='grid cols-2' style='margin-top:12px'>
        ${(livePublics.map(card).join('')) || '<div class="card">æš‚æ— å…¬å¼€è¯¾ç¨‹</div>'}
        ${(showcase.map(card).join('')) || ''}
      </div>
      ${manageTable}
    `;
    mount(shell(html)); updateSidebar();
  }
  function openShowcaseEditor(idx=null){
    const body = qs('#modal-body'), title = qs('#modal-title'), save = qs('#modal-save');
    const data = (idx!==null)? state.showcase[idx] : {id:'show-'+Date.now(), title:'', teacher:'', students:0, public:true, desc:''};
    title.textContent = (idx!==null)? 'ç¼–è¾‘å±•ç¤ºè¯¾ç¨‹' : 'æ–°å¢å±•ç¤ºè¯¾ç¨‹';
    body.innerHTML = `
      <label><div class="muted">ID</div><input id="sc-id" class="input" value="${escapeHTML(data.id)}" ${idx!==null?'readonly':''}/></label>
      <label><div class="muted">æ ‡é¢˜</div><input id="sc-title" class="input" value="${escapeHTML(data.title)}"/></label>
      <label><div class="muted">æ•™å¸ˆ</div><input id="sc-teacher" class="input" value="${escapeHTML(data.teacher||'')}"/></label>
      <label><div class="muted">å­¦ç”Ÿæ•°</div><input id="sc-students" type="number" class="input" value="${data.students||0}"/></label>
      <label><div class="muted">æè¿°</div><textarea id="sc-desc" class="input" rows="3">${escapeHTML(data.desc||'')}</textarea></label>
    `;
    save.onclick = ()=>{
      const id = qs('#sc-id').value.trim();
      const item = {
        id,
        title: qs('#sc-title').value.trim() || 'æœªå‘½åè¯¾ç¨‹',
        teacher: qs('#sc-teacher').value.trim()||'æ•™å¸ˆ',
        students: parseInt(qs('#sc-students').value||'0',10),
        desc: qs('#sc-desc').value.trim(),
        public:true
      };
      if(idx!==null) state.showcase[idx]=item; else state.showcase.unshift(item);
      closeModal(); renderHall();
    };
    qs('#modal-mask').style.display='flex';
  }
  function deleteShowcase(idx){
    if(!confirm('ç¡®è®¤åˆ é™¤è¯¥å±•ç¤ºè¯¾ç¨‹ï¼Ÿ')) return;
    state.showcase.splice(idx,1);
    renderHall();
  }

  /************** ä¼šè®®/å…¶ä»– **************/
  function renderMeeting(){
    const html = `
      <div class='card'>
        <h3>è§†é¢‘ä¼šè®®ï¼ˆå ä½ï¼‰</h3>
        <p class='muted'>æœªæ¥å°†åœ¨è¿™é‡Œé›†æˆ Zoom / WebRTC APIã€‚</p>
        <div style='margin-top:12px;display:flex;gap:8px'>
          <button class='btn primary' onclick="alert('å ä½ï¼šå°†æ‰“å¼€è§†é¢‘ä¼šè®®ï¼ˆæœªæ¥å®ç°ï¼‰')">å¼€å§‹ä¼šè®®ï¼ˆå ä½ï¼‰</button>
          <button class='btn' onclick="alert('å ä½ï¼šä¼šè®®è®¾ç½®ï¼ˆæœªæ¥å®ç°ï¼‰')">ä¼šè®®è®¾ç½®</button>
        </div>
      </div>`;
    mount(shell(html)); updateSidebar();
  }
  function renderAIStudio(){
    const html = `<h2>AI è¾…åŠ©åŠŸèƒ½</h2><div class='grid cols-2'><div class='card'><b>ä»ææ–™ç”Ÿæˆé¢˜ç›®</b></div><div class='card'><b>ç›¸ä¼¼ç­”æ¡ˆèšç±»</b></div></div>`;
    mount(shell(html)); updateSidebar();
  }
  function renderInsights(){
    const html = `<h2>ä¿¡æ¯å±•ç¤º</h2><div class='grid cols-3'><div class='card'><b>å­¦ç”Ÿå‚ä¸åº¦</b></div><div class='card'><b>å¹³å‡æ­£ç¡®ç‡</b></div><div class='card'><b>æäº¤æ—¶é•¿</b></div></div>`;
    mount(shell(html)); updateSidebar();
  }

  /************** è·¯ç”± **************/
  function route(){
    removeFloatingUI();
    let h = location.hash || '';
    if(!h){
      // å¦‚æœæ²¡æœ‰ hashï¼Œç«‹å³ç¡®å®šé»˜è®¤è·¯ç”±å¹¶åŒæ—¶æ›´æ–° URLï¼Œ
      // ç«‹å³æ¸²æŸ“ç›®æ ‡é¡µé¢ï¼ˆä¸è¦ä»…ä¾èµ– hashchange äº‹ä»¶ï¼‰ï¼Œ
      // è¿™æ ·å¯é¿å…é¡µé¢åŠ è½½æ—¶å‡ºç°ç©ºç™½ï¼ˆåœ¨æŸäº›ç¯å¢ƒä¸‹ hashchange å¯èƒ½æœªåŠæ—¶è§¦å‘ï¼‰ã€‚
      const target = state.user ? '#/teacher/courses' : '#/login';
      // æ›´æ–°åœ°å€æ 
      location.hash = target;
      // ç«‹å³æ¸²æŸ“ç›®æ ‡é¡µé¢ä»¥ä¿è¯é¡µé¢å¯è§
      (routes[target] || renderLogin)();
      setTimeout(updateSidebar, 0);
      return;
    }
    (routes[h] || renderLogin)();
    setTimeout(updateSidebar, 0);
  }

  /************** å¤åˆ¶åŠ å…¥ç ï¼ˆå…œåº•ï¼‰ **************/
  async function copyJoinCode(){
    const cid = sessionStorage.getItem('currCourse');
    const code = cid ? `JOIN-${cid}` : 'JOIN-CODE';
    try{
      if(navigator.clipboard?.writeText){ await navigator.clipboard.writeText(code); alert('åŠ å…¥ç å·²å¤åˆ¶ï¼š' + code); }
      else{ prompt('å¤åˆ¶ä»¥ä¸‹åŠ å…¥ç ï¼š', code); }
    }catch(e){ alert('å¤åˆ¶å¤±è´¥ï¼š' + (e?.message||e)); }
  }

  /************** å¯åŠ¨ **************/
  document.addEventListener('DOMContentLoaded', ()=>{
    window.addEventListener('hashchange', route);
    route();
  });
  </script>
</body>
</html>